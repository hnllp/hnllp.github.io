<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ¦‚å¿µè‹±è¯­ - æ’­æ”¾å™¨ï¼ˆå››å†Œå®Œæ•´ç‰ˆï¼‰</title>
    <!-- å¼•å…¥JSZipåº“ -->
    <script src="https://fastly.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            overflow-x: hidden;
            position: relative; /* æ–°å¢ï¼šä¸ºç»å¯¹å®šä½çš„æŠ½å±‰æŒ‰é’®æä¾›å®šä½ä¸Šä¸‹æ–‡ */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
            padding: 30px;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
            margin-top: 20px; /* æ–°å¢ï¼šé¿å…è¢«æŠ½å±‰æŒ‰é’®é®æŒ¡ */
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eef2f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #1a6dcc 0%, #007bff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            flex: 1;
            text-align: center;
        }

        /* æŠ½å±‰æ ¸å¿ƒæ ·å¼ - ä¿®å¤éƒ¨åˆ† */
        .drawer-btn {
            position: fixed; /* ä¿®æ”¹ï¼šä»absoluteæ”¹ä¸ºfixedï¼Œç¡®ä¿å§‹ç»ˆå¯è§ */
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            z-index: 9999; /* æé«˜z-indexç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            transition: all 0.3s ease;
        }
        .drawer-btn:hover {
            transform: scale(1.05);
            background: #0069d9;
        }
        .drawer-btn.active {
            left: 270px;
            background: #dc3545;
        }
        @media (max-width: 768px) {
            .drawer-btn.active {
                left: calc(100% - 64px);
            }
        }

        .drawer-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998; /* è°ƒæ•´z-index */
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .drawer-mask.active {
            display: block;
            opacity: 1;
        }

        .lesson-drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            z-index: 9999; /* è°ƒæ•´z-index */
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
            padding: 20px 10px;
        }
        .lesson-drawer.active {
            transform: translateX(0);
        }
        @media (max-width: 768px) {
            .lesson-drawer {
                width: 80%;
                max-width: 300px;
            }
        }

        /* åˆ†å†Œåˆ‡æ¢Tab - é€‚é…4ä¸ªåˆ†å†Œ */
        .volume-tabs {
            display: flex;
            gap: 4px;
            padding: 10px 15px;
            border-bottom: 2px solid #eef2f7;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .volume-tab {
            flex: 1;
            min-width: 50px;
            padding: 8px 0;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            background: #f8fafc;
            border: 1px solid #e0e6ed;
            transition: all 0.2s ease;
        }
        .volume-tab.active {
            background: #007bff;
            color: white;
            border-color: #0069d9;
        }
        .volume-tab:hover:not(.active) {
            background: #e6f0ff;
            border-color: #007bff;
        }

        .drawer-header {
            padding: 10px 15px;
            border-bottom: 2px solid #eef2f7;
            margin-bottom: 15px;
        }
        .drawer-title {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        .drawer-title::before {
            content: "";
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #007bff;
        }
        .current-volume {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            padding-left: 16px;
        }
        /* æ–°å¢ï¼šè¯¾ç¨‹è·³è½¬è¾“å…¥æ¡†+å®šä½æŒ‰é’®æ ·å¼ */
        .drawer-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            gap: 6px;
            align-items: center;
        }
        .lesson-jump-input {
            width: 60px;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #e0e6ed;
            font-size: 0.8rem;
            text-align: center;
        }
        .lesson-jump-input:focus {
            outline: none;
            border-color: #007bff;
        }
        .jump-btn {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #007bff;
            color: #007bff;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .jump-btn:hover {
            background: #e6f0ff;
        }
        .locate-btn {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #007bff;
            color: #007bff;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .locate-btn:hover {
            background: #e6f0ff;
        }
        /* æ–°å¢ï¼šè¯¾ç¨‹å®šä½é—ªçƒåŠ¨ç”» */
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; box-shadow: 0 0 10px #007bff; }
        }

        .lesson-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 10px 15px;
        }
        .lesson-item {
            padding: 8px 0;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #e0e6ed;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .lesson-item:hover {
            transform: translateY(-2px);
            border-color: #007bff;
            background: #e6f0ff;
        }
        .lesson-item.active {
            background: #007bff;
            color: #fff;
            border-color: #0069d9;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.25);
        }

        .lyrics-container {
            height: 320px; 
            overflow-y: auto; 
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e0e6ed;
            position: relative;
        }
        .lyric-line {
            padding: 10px 0;
            text-align: center;
            font-size: 17px;
            margin: 3px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .lyric-line:hover {
            background: #f0f5ff;
        }
        .lyric-line.active {
            background: rgba(0, 123, 255, 0.25);
            font-weight: bold;
            font-size: 19px;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        /* æ–°å¢ï¼šç©ºç™½è¡Œæ ·å¼ï¼Œä¸å½±å“è§†è§‰ä½†å ç©ºé—´ */
        .blank-line {
            padding: 10px 0;
            height: 37px; /* å’Œæ­Œè¯è¡Œé«˜åº¦ä¸€è‡´ */
            visibility: hidden;
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            padding: 15px;
            background: #f0f4fa;
            border-radius: 12px;
            border: 1px solid #e0e6ed;
        }
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-outline {
            background: white;
            border: 2px solid #007bff;
            color: #007bff;
        }
        .btn.loop-active {
            background: #28a745;
            color: white;
        }
        /* æ–°å¢ï¼šè¯­é€ŸæŒ‰é’®æ ·å¼ */
        .speed-controls {
            display: flex;
            gap: 4px;
        }
        .speed-btn {
            padding: 8px 12px !important;
            font-size: 0.9rem !important;
        }
        .speed-btn.active {
            background: #007bff;
            color: white;
            border-color: #0069d9;
        }

        .progress {
            flex: 1;
            min-width: 250px;
            height: 10px;
            background: #e0e6ed;
            border-radius: 5px;
            cursor: pointer;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            border-radius: 5px;
            width: 0%;
            transition: width 0.2s;
        }
        .time {
            font-size: 13px;
            color: #666;
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
        }
        .status-indicator.off {
            background: #dc3545;
        }
        .instructions {
            background: #e6f7ff;
            border-radius: 12px;
            padding: 18px;
            margin-top: 25px;
            border-left: 4px solid #007bff;
        }
        .instructions h3 {
            color: #007bff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .instructions ul {
            padding-left: 20px;
        }
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .highlight {
            background: #e6f7ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin-top: 70px; /* å¢åŠ é¡¶éƒ¨é—´è·ï¼Œé¿å…è¢«æŠ½å±‰æŒ‰é’®é®æŒ¡ */
            }
            .header {
                flex-direction: column;
                gap: 10px;
            }
            .header h1 {
                font-size: 2rem;
            }
            .drawer-btn {
                top: 15px;
                left: 15px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .progress {
                min-width: 100%;
            }
            .lesson-list {
                grid-template-columns: repeat(4, 1fr);
            }
            .speed-controls {
                margin-bottom: 10px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- æŠ½å±‰å¼€å…³æŒ‰é’® -->
    <button class="drawer-btn" id="drawerBtn">â˜°</button>
    <!-- æŠ½å±‰é®ç½©å±‚ -->
    <div class="drawer-mask" id="drawerMask"></div>
    <!-- è¯¾ç¨‹åˆ—è¡¨æŠ½å±‰ -->
    <div class="lesson-drawer" id="lessonDrawer">
        <!-- åˆ†å†Œåˆ‡æ¢Tab - æ–°å¢ç¬¬å››å†Œ -->
        <div class="volume-tabs">
            <div class="volume-tab active" data-volume="1">ç¬¬ä¸€å†Œ</div>
            <div class="volume-tab" data-volume="2">ç¬¬äºŒå†Œ</div>
            <div class="volume-tab" data-volume="3">ç¬¬ä¸‰å†Œ</div>
            <div class="volume-tab" data-volume="4">ç¬¬å››å†Œ</div>
        </div>
        
        <div class="drawer-header">
            <div class="drawer-title" id="drawerTitle">é€‰æ‹©è¯¾ç¨‹</div>
            <div class="current-volume" id="currentVolume">å½“å‰ï¼šç¬¬ä¸€å†Œï¼ˆå…±144è¯¾ï¼‰</div>
            <!-- æ–°å¢ï¼šè¯¾ç¨‹è·³è½¬è¾“å…¥æ¡† + è·³è½¬æŒ‰é’® + å®šä½æŒ‰é’® -->
            <div class="drawer-actions">
                <input type="number" class="lesson-jump-input" id="lessonJumpInput" placeholder="è¯¾å·" min="1">
                <button class="jump-btn" id="jumpBtn">è·³è½¬</button>
                <button class="locate-btn" id="locateBtn">å®šä½å½“å‰è¯¾</button>
            </div>
        </div>
        <div class="lesson-list" id="lessonList"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>æ–°æ¦‚å¿µè‹±è¯­ æ’­æ”¾å™¨</h1>
        </div>
        
        <div class="lyrics-container" id="lyricsContainer">
            <div style="text-align: center; color: #666; padding: 40px 0; font-size: 1.1rem;">
                <div style="font-size: 2.5rem; margin-bottom: 15px;">ğŸ“š</div>
                <div>è¯·ç‚¹å‡»å·¦ä¾§æŒ‰é’®é€‰æ‹©è¯¾ç¨‹</div>
                <div style="font-size: 0.9rem; margin-top: 10px; color: #888;">æ”¯æŒå•å¥å¾ªç¯ç»ƒä¹ ï¼Œç‚¹å‡»å­—å¹•å¯è·³è½¬åˆ°å¯¹åº”ä½ç½®</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-outline" id="prevBtn">ä¸Šä¸€è¯¾</button>
            <button class="btn btn-primary" id="playBtn">â–¶ æ’­æ”¾</button>
            <button class="btn btn-outline" id="nextBtn">ä¸‹ä¸€è¯¾</button>
            <button class="btn btn-outline" id="singleLoopBtn">å•å¥å¾ªç¯</button>
            <button class="btn btn-outline" id="fullLoopBtn">æ•´é¦–å¾ªç¯</button>
            <button class="btn btn-outline" id="downloadLyricBtn">ä¸‹è½½å­—å¹•</button>
            <button class="btn btn-outline" id="downloadTransBtn">ä¸‹è½½ç¿»è¯‘</button>
            <!-- æ–°å¢ï¼šè¯­é€Ÿè°ƒèŠ‚æŒ‰é’®ç»„ -->
            <div class="speed-controls">
                <button class="btn btn-outline speed-btn" data-speed="0.75">0.75x</button>
                <button class="btn btn-outline speed-btn active" data-speed="1">1x</button>
                <button class="btn btn-outline speed-btn" data-speed="1.25">1.25x</button>
                <button class="btn btn-outline speed-btn" data-speed="1.5">1.5x</button>
            </div>
            
            <div style="width: 100%; margin-top: 10px;">
                <div class="progress" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time">
                    <span id="currentTime">00:00</span>
                    <span id="totalTime">00:00</span>
                </div>
                <div class="status-bar">
                    <div class="status-item">
                        <span class="status-indicator" id="loopStatus"></span>
                        <span id="loopStatusText">å•å¥å¾ªç¯ï¼šå…³é—­</span>
                    </div>
                    <div class="status-item">
                        <span class="status-indicator" id="fullLoopStatus"></span>
                        <span id="fullLoopStatusText">æ•´é¦–å¾ªç¯ï¼šå…³é—­</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3><span>ğŸ’¡</span> ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li>ç‚¹å‡»<span class="highlight">å·¦ä¾§æŒ‰é’®</span>æ‰“å¼€è¯¾ç¨‹åˆ—è¡¨ï¼Œå…ˆé€‰æ‹©åˆ†å†Œï¼Œå†é€‰æ‹©è¯¾ç¨‹</li>
                <li>æ’­æ”¾åå­—å¹•ä¼šè‡ªåŠ¨åŒæ­¥é«˜äº®ï¼Œç‚¹å‡»å­—å¹•è¡Œå¯å¿«é€Ÿè·³è½¬åˆ°è¯¥å¥</li>
                <li>å¼€å¯ <span class="highlight">å•å¥å¾ªç¯</span> æ¨¡å¼åï¼Œå½“å‰å¥å­å°†é‡å¤æ’­æ”¾ï¼Œä¾¿äºè·Ÿè¯»ç»ƒä¹ </li>
                <li>å¼€å¯ <span class="highlight">æ•´é¦–å¾ªç¯</span> æ¨¡å¼åï¼Œæ•´ç¯‡æ–‡ç« å°†å¾ªç¯æ’­æ”¾</li>
                <li>ä½¿ç”¨ <span class="highlight">è¿›åº¦æ¡</span> å¯æ‹–åŠ¨åˆ°ä»»æ„ä½ç½®ï¼Œæ”¯æŒç²¾ç»†æ§åˆ¶æ’­æ”¾è¿›åº¦</li>
                <li>ç‚¹å‡» <span class="highlight">ä¸‹è½½å­—å¹•</span> å¯ä¿å­˜æ–‡æœ¬åˆ°æœ¬åœ°ï¼Œæ–¹ä¾¿ç¦»çº¿å­¦ä¹ </li>
                <li>ç‚¹å‡» <span class="highlight">ä¸‹è½½ç¿»è¯‘</span> å¯ä¿å­˜æµè§ˆå™¨ç¿»è¯‘åçš„æ–‡æœ¬åˆ°æœ¬åœ°</li>
                <li>æ”¯æŒ <span class="highlight">0.75x-1.5x</span> è¯­é€Ÿè°ƒèŠ‚ï¼Œé€‚é…ä¸åŒå­¦ä¹ èŠ‚å¥</li>
                <li>é¡µé¢ä¼šè‡ªåŠ¨è®°å¿†å­¦ä¹ è¿›åº¦ï¼Œä¸‹æ¬¡æ‰“å¼€æ— éœ€é‡æ–°é€‰æ‹©è¯¾ç¨‹</li>
                <li>è¯¾ç¨‹åˆ—è¡¨è¾“å…¥<span class="highlight">è¯¾å·</span>ç‚¹å‡»è·³è½¬ï¼Œå¯å¿«é€Ÿå®šä½åˆ°æŒ‡å®šè¯¾ç¨‹</li>
                <li>è¯¾ç¨‹åˆ—è¡¨ç‚¹å‡»ã€Œå®šä½å½“å‰è¯¾ã€å¯å¿«é€Ÿæ‰¾åˆ°æ­£åœ¨å­¦ä¹ çš„è¯¾ç¨‹</li>
            </ul>
        </div>
    </div>
    <audio id="audioPlayer" preload="metadata"></audio>

    <script>
        // 1. å››å†Œè¯¾ç¨‹æ•°æ® - ä¸¥æ ¼åŒ¹é…æŒ‡å®šç»“æ„
        const allLessons = {
            // ç¬¬ä¸€å†Œï¼š144è¯¾ï¼ˆå‰5è¯¾çœŸå®æ•°æ® + 139è¯¾å ä½ï¼‰
            1: [
                { id: 1, lessonId: "608a11a4e9ec33401cf022dc", goodsId: "12177", mp3: "https://vod.unischool.cn/ab38fc4e71c840eda610e9f3c573c22e%2F6af96aa4744f3409c231469c32be4379-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/5fa8b44c33ca433d9ec5cd403c08a336.lrc" },
                { id: 2, lessonId: "608a11a4e9ec33401cf022dd", goodsId: "12177", mp3: "https://vod.unischool.cn/5dd13556c6534c1fa99c0b503c5689b9%2Ffbcb8c611d96f105f82a1c7f9549824b-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/dc168e4ab62d4e2ba50bedee245ff112.lrc" },
                { id: 3, lessonId: "608a11a4e9ec33401cf022de", goodsId: "12177", mp3: "https://vod.unischool.cn/0b5ef7f1b1b040ac93c363e7e6df1e96%2F82dc3609624b3c47cc9e4c3aed38a94a-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/e5d3a5ca0f0e4bf28cd01bff50a098ff.lrc" },
                { id: 4, lessonId: "608a11a4e9ec33401cf022df", goodsId: "12177", mp3: "https://vod.unischool.cn/35d57da801c448a0bbd773d30aa660c5%2Fbd0fbfe8593871fdf015c75ba51a8ccf-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/1e8ff109ab6f44de8b3c6a636a0e33d7.lrc" },
                { id: 5, lessonId: "608a11a4e9ec33401cf022e0", goodsId: "12177", mp3: "https://vod.unischool.cn/7ecbe7410c76432a88cb35bef9ee8476%2Fcc90e9aa698fa80093156b17de9f2412-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/644a18971a2d4cb5bea48e50b7cff676.lrc" },
                // æ‰¹é‡ç”Ÿæˆå‰©ä½™139è¯¾ï¼ˆid6-144ï¼‰
                ...Array.from({length: 139}, (_, i) => ({
                    id: 6 + i,
                    lessonId: `608a0de7485c4e537a00d${687 + i}`,
                    goodsId: "12177",
                    mp3: `https://vod.unischool.cn/demo/${6+i}-sq.mp3`,
                    lrc: `https://enrt.diplotalk.unischool.cn/doc/material/demo${6+i}.lrc`
                }))
            ],
            
            // ç¬¬äºŒå†Œï¼š96è¯¾ï¼ˆå‰3è¯¾çœŸå®æ•°æ® + 93è¯¾å ä½ï¼‰
            2: [
                { id: 1, lessonId: "608a0de7485c4e537a00d680", goodsId: "12176", mp3: "https://vod.unischool.cn/d8c41704163141c481906baf5cd5ec56%2F5dcaa0e1e846890bffe58a6aa68bd84f-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/4bf58234361b4b23ae0fa9aeb98a260f.lrc" },
                { id: 2, lessonId: "608a0de7485c4e537a00d681", goodsId: "12176", mp3: "https://vod.unischool.cn/a67d67d39a314e4a895192d7d28b8dc7%2F4f124bbd48e3db37091d1a2b32a8bf51-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/56998e2ec8ff4394bf02fa5b944b58b7.lrc" },
                { id: 3, lessonId: "608a0de7485c4e537a00d682", goodsId: "12176", mp3: "https://vod.unischool.cn/c1715b9d8583437cad3a482d6424e17e%2Ff0379b60adf09618ec5b81b684fa2316-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/cd680eef93234063a7a9f9adba6bd9b5.lrc" },
                // æ‰¹é‡ç”Ÿæˆå‰©ä½™93è¯¾ï¼ˆid4-96ï¼‰
                ...Array.from({length: 93}, (_, i) => ({
                    id: 4 + i,
                    lessonId: `608a0de7485c4e537a00d${683 + i}`,
                    goodsId: "12176",
                    mp3: `https://vod.unischool.cn/demo/volume2/${4+i}-sq.mp3`,
                    lrc: `https://enrt.diplotalk.unischool.cn/doc/material/volume2/demo${4+i}.lrc`
                }))
            ],
            
            // ç¬¬ä¸‰å†Œï¼š60è¯¾ï¼ˆåŸæœ‰æ•°æ® + è¡¥å……3-59è¯¾å ä½ï¼‰
            3: [
                { id: 1, lessonId: "60e6e59d13fde07e76d852b1", goodsId: "12263", mp3: "https://vod.unischool.cn/55d3e1d2c1084c9f8c7557620db9edf8%2F7a3da46c5614cb0e328c8daa8d5013df-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/22803a925554412984e1e2207a24951b.lrc" },
                { id: 2, lessonId: "60e6e59d13fde07e76d852b2", goodsId: "12263", mp3: "https://vod.unischool.cn/f77c5a154ec74433a4d3478f35bbc351%2F59fb6e2539a1ef122a1e35a2f1b607d6-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/2c6dbf91e0254092bf57f61a001c323f.lrc" },
                // æ‰¹é‡ç”Ÿæˆ3-59è¯¾å ä½
                ...Array.from({length: 57}, (_, i) => ({
                    id: 3 + i,
                    lessonId: `60e6e59d13fde07e76d852${(0xb3 + i).toString(16)}`,
                    goodsId: "12263",
                    mp3: `https://vod.unischool.cn/demo/volume3/${3+i}-sq.mp3`,
                    lrc: `https://enrt.diplotalk.unischool.cn/doc/material/volume3/demo${3+i}.lrc`
                })),
                { id: 60, lessonId: "60e6e59d13fde07e76d852ec", goodsId: "12263", mp3: "https://vod.unischool.cn/90ab5ca693784a26b3d069f895b6afde%2Fff9068be8e351b2900dcf2bab1e087b5-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/aa76847f515246899154c11d84641eac.lrc" }
            ],

            // ç¬¬å››å†Œï¼š48è¯¾ï¼ˆå‰ä¸‰è¯¾çœŸå®æ•°æ® + 45è¯¾å ä½ï¼Œæ— ç›´æ¥lrcå­—æ®µï¼Œéœ€åŠ¨æ€è·å–ï¼‰
            4: [
                { id: 1, lessonId: "60f135c59e05b5384d340e86", goodsId: "12276", mp3: "https://vod.unischool.cn/5fdf873b8db243c5b112bd2336efad89%2Febb5d236653f436f1e5a775a50191986-sq.mp3" },
                { id: 2, lessonId: "60f135c59e05b5384d340e87", goodsId: "12276", mp3: "https://vod.unischool.cn/01c5985aba584eb7b6d296a9c2735f5c%2F717b0abef765995c0bacf541a2487819-sq.mp3" },
                { id: 3, lessonId: "60f135c59e05b5384d340e88", goodsId: "12276", mp3: "https://vod.unischool.cn/03107c78c98e4389c50a79ec85cbd73%2F7e6c900ff23fdefdb478f0d6f8f583b7-sq.mp3" },
                // æ‰¹é‡ç”Ÿæˆå‰©ä½™45è¯¾å ä½ï¼ˆid4-48ï¼‰
                ...Array.from({length: 45}, (_, i) => ({
                    id: 4 + i,
                    lessonId: `60f135c59e05b5384d340${(0xe89 + i).toString(16)}`,
                    goodsId: "12276",
                    mp3: `https://vod.unischool.cn/demo/volume4/${4+i}-sq.mp3`
                }))
            ]
        };

        // 2. å…¨å±€å˜é‡
        const audio = document.getElementById('audioPlayer');
        let currentVolume = 1; // é»˜è®¤é€‰ä¸­ç¬¬ä¸€å†Œ
        let currentLessonIndex = 0; // å½“å‰å†Œçš„è¯¾ç¨‹ç´¢å¼•
        let currentVolumeLessons = allLessons[currentVolume]; // å½“å‰å†Œçš„è¯¾ç¨‹åˆ—è¡¨
        
        let lyrics = [];
        let isPlaying = false;
        let isSingleLoop = false; 
        let isFullLoop = false; 
        let currentLyricIndex = -1;
        let sentenceStart = 0;
        let sentenceEnd = 0;
        let isJumping = false;
        let loopCheckTimer = null;
        let isDrawerOpen = false; // ç¡®ä¿åˆå§‹åŒ–ä¸ºfalse
        
        // æ–°å¢ï¼šè¯­é€Ÿè°ƒèŠ‚ç›¸å…³å˜é‡
        let playbackSpeed = 1;
        
        // ZIPåŒ…ç›¸å…³å…¨å±€å˜é‡
        let zipInstance = null;
        const BASE_PATH = ''; // æ ¹æ®å®é™…éƒ¨ç½²è·¯å¾„è°ƒæ•´
        
        // 3. DOMå…ƒç´ 
        const els = {
            drawerBtn: document.getElementById('drawerBtn'),
            drawerMask: document.getElementById('drawerMask'),
            lessonDrawer: document.getElementById('lessonDrawer'),
            volumeTabs: document.querySelectorAll('.volume-tab'),
            drawerTitle: document.getElementById('drawerTitle'),
            currentVolume: document.getElementById('currentVolume'),
            lessonList: document.getElementById('lessonList'),
            lyricsContainer: document.getElementById('lyricsContainer'),
            playBtn: document.getElementById('playBtn'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            singleLoopBtn: document.getElementById('singleLoopBtn'),
            fullLoopBtn: document.getElementById('fullLoopBtn'),
            downloadLyricBtn: document.getElementById('downloadLyricBtn'),
            downloadTransBtn: document.getElementById('downloadTransBtn'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            currentTime: document.getElementById('currentTime'),
            totalTime: document.getElementById('totalTime'),
            loopStatus: document.getElementById('loopStatus'),
            loopStatusText: document.getElementById('loopStatusText'),
            fullLoopStatus: document.getElementById('fullLoopStatus'),
            fullLoopStatusText: document.getElementById('fullLoopStatusText'),
            // æ–°å¢ï¼šè¯¾ç¨‹è·³è½¬ç›¸å…³å…ƒç´ 
            lessonJumpInput: document.getElementById('lessonJumpInput'),
            jumpBtn: document.getElementById('jumpBtn'),
            locateBtn: document.getElementById('locateBtn')
        };

        // ========== ZIPåŒ…ç›¸å…³å‡½æ•° ==========
        /**
         * åŠ è½½ä¼ªè£…çš„ZIPåŒ…ï¼ˆrs.cssï¼‰åˆ°å†…å­˜ï¼ˆä»…è§£æç»“æ„ï¼Œä¸è§£å‹å…¨é‡æ–‡ä»¶ï¼‰
         * @returns {Promise<boolean>} æ˜¯å¦åŠ è½½æˆåŠŸ
         */
        async function loadZipToMemory() {
            try {
                // åŠ è½½ä¼ªè£…çš„å‹ç¼©åŒ…æ–‡ä»¶ï¼ˆrs.cssï¼‰
                const response = await fetch(`${BASE_PATH}rs.css`);
                if (!response.ok) throw new Error(`åŠ è½½ZIPèµ„æºå¤±è´¥ï¼š${response.status}`);
                
                // è¯»å–ä¸ºäºŒè¿›åˆ¶Blobæ•°æ®
                const blob = await response.blob();
                const jszip = new JSZip();
                
                // ä»…è§£æZIPç»“æ„ï¼Œç¼“å­˜å®ä¾‹åˆ°å†…å­˜ï¼ˆä¸è§£å‹æ–‡ä»¶å†…å®¹ï¼‰
                zipInstance = await jszip.loadAsync(blob);
                
                console.log(`âœ… æˆåŠŸåŠ è½½ZIPåŒ…åˆ°å†…å­˜ï¼Œå…±åŒ…å« ${Object.keys(zipInstance.files).length} ä¸ªæ–‡ä»¶`);
                return true;
            } catch (error) {
                console.error('âŒ åŠ è½½ZIPåŒ…å¤±è´¥ï¼š', error);
                return false;
            }
        }

        /**
         * ä»å†…å­˜ä¸­çš„ZIPåŒ…è¯»å–æŒ‡å®šçš„LRCæ–‡ä»¶
         * @param {number} volume - åˆ†å†Œç¼–å·ï¼ˆ1-4ï¼‰
         * @param {number} lessonId - è¯¾ç¨‹ç¼–å·
         * @returns {Promise<string|null>} LRCæ–‡æœ¬å†…å®¹ï¼ˆå¤±è´¥è¿”å›nullï¼‰
         */
        async function getLrcFromZip(volume, lessonId) {
            // æ ¡éªŒZIPå®ä¾‹æ˜¯å¦å·²åŠ è½½
            if (!zipInstance) {
                console.error('âŒ ZIPåŒ…å°šæœªåŠ è½½ï¼Œæ­£åœ¨å°è¯•åŠ è½½...');
                const loadSuccess = await loadZipToMemory();
                if (!loadSuccess) return null;
            }

            // æ„é€ ZIPå†…çš„LRCæ–‡ä»¶è·¯å¾„
            const targetFilePath = `volume${volume}/lesson${lessonId}.lrc`;

            // æ£€æŸ¥ZIPä¸­æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶
            if (!zipInstance.files[targetFilePath]) {
                console.error(`âŒ ZIPåŒ…ä¸­æœªæ‰¾åˆ°æ–‡ä»¶ï¼š${targetFilePath}`);
                return null;
            }

            try {
                // ä»…è¯»å–å½“å‰éœ€è¦çš„LRCæ–‡ä»¶å†…å®¹ï¼ˆå†…å­˜ä¸­æ“ä½œï¼Œä¸è§£å‹å…¨é‡æ–‡ä»¶ï¼‰
                const lrcText = await zipInstance.files[targetFilePath].async('text');
                console.log(`âœ… æˆåŠŸä»ZIPåŒ…è¯»å–LRCæ–‡ä»¶ï¼š${targetFilePath}`);
                return lrcText;
            } catch (error) {
                console.error(`âŒ è¯»å–LRCæ–‡ä»¶å¤±è´¥ï¼š${error.message}`);
                return null;
            }
        }

        // 4. æŠ½å±‰æ§åˆ¶å‡½æ•° - ä¿®å¤é€»è¾‘
        function toggleDrawer() {
            isDrawerOpen = !isDrawerOpen;
            
            // ç¡®ä¿DOMå…ƒç´ å­˜åœ¨å†æ“ä½œ
            if (els.lessonDrawer) els.lessonDrawer.classList.toggle('active', isDrawerOpen);
            if (els.drawerMask) els.drawerMask.classList.toggle('active', isDrawerOpen);
            if (els.drawerBtn) {
                els.drawerBtn.classList.toggle('active', isDrawerOpen);
                els.drawerBtn.textContent = isDrawerOpen ? 'âœ•' : 'â˜°';
            }
            
            // æ§åˆ¶é¡µé¢æ»šåŠ¨
            document.body.style.overflow = isDrawerOpen ? 'hidden' : 'auto';
            
            // è°ƒè¯•ä¿¡æ¯
            console.log('æŠ½å±‰çŠ¶æ€:', isDrawerOpen);
        }

        // 5. åˆ‡æ¢åˆ†å†Œ
        function switchVolume(volume) {
            if (volume === currentVolume) return;
            
            // æ›´æ–°åˆ†å†ŒçŠ¶æ€
            currentVolume = volume;
            currentLessonIndex = 0;
            currentVolumeLessons = allLessons[currentVolume];
            
            // æ›´æ–°Tabæ ·å¼
            els.volumeTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.volume === volume.toString());
            });
            
            // æ›´æ–°æŠ½å±‰æ ‡é¢˜ï¼ˆæ˜¾ç¤ºå¯¹åº”å†Œçš„æ€»è¯¾æ•°ï¼‰
            const totalLessons = {
                1: 144,
                2: 96,
                3: 60,
                4: 48
            };
            els.currentVolume.textContent = `å½“å‰ï¼šç¬¬${volume}å†Œï¼ˆå…±${totalLessons[volume]}è¯¾ï¼‰`;
            
            // é‡æ–°æ¸²æŸ“è¯¾ç¨‹åˆ—è¡¨
            initLessonList();
            
            // é‡ç½®æ’­æ”¾çŠ¶æ€
            isSingleLoop = false;
            updateLoopStatus();
            pauseAudio();
            els.lyricsContainer.innerHTML = `
                <div style="text-align: center; color: #666; padding: 40px 0; font-size: 1.1rem;">
                    <div style="font-size: 2.5rem; margin-bottom: 15px;">ğŸ“š</div>
                    <div>è¯·é€‰æ‹©ç¬¬${volume}å†Œçš„è¯¾ç¨‹å¼€å§‹æ’­æ”¾</div>
                </div>
            `;
            
            // ä¿å­˜è¿›åº¦
            saveProgress();
        }

        // 6. åˆå§‹åŒ–è¯¾ç¨‹åˆ—è¡¨
        function initLessonList() {
            els.lessonList.innerHTML = '';
            currentVolumeLessons.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = `lesson-item ${idx === currentLessonIndex ? 'active' : ''}`;
                div.textContent = `ç¬¬${item.id}è¯¾`;
                div.onclick = () => {
                    selectLesson(idx);
                    toggleDrawer();
                };
                els.lessonList.appendChild(div);
            });
        }

        // æ–°å¢ï¼šè¯¾ç¨‹å·è·³è½¬å‡½æ•°
        function jumpToLesson() {
            const lessonNum = parseInt(els.lessonJumpInput.value.trim());
            if (isNaN(lessonNum)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è¯¾ç¨‹æ•°å­—ï¼');
                els.lessonJumpInput.focus();
                return;
            }
            
            // è·å–å½“å‰åˆ†å†Œçš„è¯¾ç¨‹æ€»æ•°
            const totalLessons = {
                1: 144,
                2: 96,
                3: 60,
                4: 48
            }[currentVolume];
            
            if (lessonNum < 1 || lessonNum > totalLessons) {
                alert(`ç¬¬${currentVolume}å†Œåªæœ‰1-${totalLessons}è¯¾ï¼Œè¯·è¾“å…¥æœ‰æ•ˆèŒƒå›´ï¼`);
                els.lessonJumpInput.focus();
                return;
            }
            
            // æ‰¾åˆ°å¯¹åº”è¯¾ç¨‹çš„ç´¢å¼•
            const lessonIndex = currentVolumeLessons.findIndex(item => item.id === lessonNum);
            if (lessonIndex === -1) {
                alert('æœªæ‰¾åˆ°è¯¥è¯¾ç¨‹ï¼Œè¯·é‡è¯•ï¼');
                return;
            }
            
            // é€‰æ‹©è¯¾ç¨‹å¹¶å®šä½
            selectLesson(lessonIndex);
            locateCurrentLesson();
            // æ¸…ç©ºè¾“å…¥æ¡†
            els.lessonJumpInput.value = '';
        }

        // æ–°å¢ï¼šè¯¾ç¨‹åˆ—è¡¨å¿«é€Ÿå®šä½å‡½æ•°
        function locateCurrentLesson() {
            const activeLesson = document.querySelector('.lesson-item.active');
            if (activeLesson) {
                // æ»šåŠ¨åˆ°å½“å‰è¯¾ç¨‹
                activeLesson.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // é«˜äº®é—ªçƒæç¤º
                activeLesson.style.animation = 'flash 1s ease';
                setTimeout(() => {
                    activeLesson.style.animation = '';
                }, 1000);
            } else {
                alert('æš‚æ— é€‰ä¸­çš„è¯¾ç¨‹');
            }
        }

        // 7. è§£æLRCæ–‡æœ¬
        function parseLrcText(lrcText) {
            const lyrics = [];
            
            // æŒ‰è¡Œè§£æLRCå†…å®¹
            lrcText.split('\n').forEach(line => {
                // åŒ¹é…LRCæ—¶é—´æ ‡ç­¾æ ¼å¼ï¼š[mm:ss.xx]æ–‡æœ¬å†…å®¹
                const match = line.match(/\[(\d{2}):(\d{2}\.\d{2})\](.*)/);
                if (match) {
                    // è½¬æ¢ä¸ºç§’æ•°ï¼ˆä¾¿äºæ—¶é—´è®¡ç®—ï¼‰
                    const time = parseInt(match[1]) * 60 + parseFloat(match[2]);
                    // æ¸…ç†æ–‡æœ¬å†…å®¹ï¼ˆå»é™¤é¦–å°¾ç©ºæ ¼ï¼‰
                    const text = match[3].trim() || ' ';
                    lyrics.push({ time, text });
                }
            });
            
            // æŒ‰æ—¶é—´æ’åº
            lyrics.sort((a, b) => a.time - b.time);
            return lyrics;
        }

        // 8. é€‰æ‹©è¯¾ç¨‹
        async function selectLesson(idx) {
            if (idx < 0 || idx >= currentVolumeLessons.length) return;
            
            currentLessonIndex = idx;
            const lesson = currentVolumeLessons[currentLessonIndex];
            
            // æ›´æ–°è¯¾ç¨‹é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.lesson-item').forEach((item, i) => {
                item.className = `lesson-item ${i === currentLessonIndex ? 'active' : ''}`;
            });
            
            // åŠ è½½éŸ³é¢‘
            audio.src = lesson.mp3;
            audio.load();
            // è®¾ç½®è¯­é€Ÿ
            audio.playbackRate = playbackSpeed;
            
            // é‡ç½®å•å¥å¾ªç¯
            isSingleLoop = false;
            updateLoopStatus();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            els.lyricsContainer.innerHTML = `
                <div style="text-align: center; color: #666; padding: 40px 0; font-size: 1.1rem;">
                    <div style="font-size: 2.5rem; margin-bottom: 15px;">â³</div>
                    <div>æ­£åœ¨åŠ è½½ç¬¬${currentVolume}å†Œç¬¬${lesson.id}è¯¾å­—å¹•...</div>
                </div>
            `;

            // ä»ZIPåŒ…åŠ è½½LRCæ–‡ä»¶
            const lrcText = await getLrcFromZip(currentVolume, lesson.id);
            if (lrcText) {
                // è§£æLRCæ–‡æœ¬
                lyrics = parseLrcText(lrcText);
                renderLyrics();
            } else {
                // ZIPåŠ è½½å¤±è´¥ï¼Œç”Ÿæˆç¤ºä¾‹æ­Œè¯
                lyrics = [
                    { time: 0.00, text: `ç¬¬${currentVolume}å†Œç¬¬${lesson.id}è¯¾ - ç¤ºä¾‹å¥å­1` },
                    { time: 5.00, text: `ç¬¬${currentVolume}å†Œç¬¬${lesson.id}è¯¾ - ç¤ºä¾‹å¥å­2` },
                    { time: 10.00, text: `ç¬¬${currentVolume}å†Œç¬¬${lesson.id}è¯¾ - ç¤ºä¾‹å¥å­3` },
                    { time: 15.00, text: `ç¬¬${currentVolume}å†Œç¬¬${lesson.id}è¯¾ - ç¤ºä¾‹å¥å­4` },
                    { time: 20.00, text: `ç¬¬${currentVolume}å†Œç¬¬${lesson.id}è¯¾ - ç¤ºä¾‹å¥å­5` }
                ];
                renderLyrics();
                console.warn(`âš ï¸ ä½¿ç”¨ç¤ºä¾‹æ­Œè¯ï¼šç¬¬${currentVolume}å†Œç¬¬${lesson.id}è¯¾`);
            }
            
            playAudio();
            
            // ä¿å­˜è¿›åº¦
            saveProgress();
        }

        // 9. æ¸²æŸ“æ­Œè¯ï¼ˆæ–°å¢åº•éƒ¨ç©ºç™½è¡Œï¼‰
        function renderLyrics() {
            if (!lyrics.length) {
                els.lyricsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px 0; font-size: 1.1rem;">
                        <div style="font-size: 2.5rem; margin-bottom: 15px;">ğŸ”</div>
                        <div>æš‚æ— å­—å¹•</div>
                    </div>
                `;
                return;
            }
            
            els.lyricsContainer.innerHTML = '';
            lyrics.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'lyric-line';
                div.textContent = item.text;
                div.onclick = () => {
                    audio.currentTime = item.time;
                    syncLyrics();
                    if (isSingleLoop) {
                        updateSentenceRange();
                    }
                };
                els.lyricsContainer.appendChild(div);
            });
            
            // æ·»åŠ 8è¡Œç©ºç™½è¡Œï¼Œé¿å…æœ€åå‡ å¥æ»šåŠ¨æ—¶å¸¦åŠ¨é¡µé¢
            for (let i = 0; i < 8; i++) {
                const blankDiv = document.createElement('div');
                blankDiv.className = 'blank-line';
                blankDiv.textContent = ' ';
                els.lyricsContainer.appendChild(blankDiv);
            }
            
            if (lyrics.length > 0) {
                currentLyricIndex = 0;
                syncLyrics();
                updateSentenceRange();
            }
        }

        // 10. åŒæ­¥æ­Œè¯
        function syncLyrics() {
            const currentTime = audio.currentTime;
            let newIndex = -1;

            for (let i = 0; i < lyrics.length; i++) {
                if (currentTime >= lyrics[i].time && (i === lyrics.length-1 || currentTime < lyrics[i+1].time)) {
                    newIndex = i;
                    break;
                }
            }

            if (newIndex === currentLyricIndex || newIndex === -1) return;
            currentLyricIndex = newIndex;

            const lines = document.querySelectorAll('.lyric-line');
            lines.forEach((line, idx) => {
                line.className = `lyric-line ${idx === newIndex ? 'active' : ''}`;
            });
            
            if (lines[newIndex]) {
                lines[newIndex].scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }

            if (isSingleLoop) {
                updateSentenceRange();
            }
        }

        // 11. æ›´æ–°å½“å‰å¥æ—¶é—´èŒƒå›´
        function updateSentenceRange() {
            if (currentLyricIndex === -1 || currentLyricIndex >= lyrics.length) return;
            
            sentenceStart = lyrics[currentLyricIndex].time;
            sentenceEnd = currentLyricIndex === lyrics.length - 1 
                ? audio.duration 
                : lyrics[currentLyricIndex + 1].time;
            if (currentLyricIndex === lyrics.length - 1) {
                sentenceEnd = Math.min(audio.duration, sentenceEnd + 0.5);
            }
        }

        // 12. æ’­æ”¾/æš‚åœ
        function playAudio() {
            audio.play();
            isPlaying = true;
            els.playBtn.textContent = 'âšâš æš‚åœ';
            startLoopCheck();
        }
        function pauseAudio() {
            audio.pause();
            isPlaying = false;
            els.playBtn.textContent = 'â–¶ æ’­æ”¾';
            stopLoopCheck();
            
            // æš‚åœæ—¶ä¿å­˜è¿›åº¦
            saveProgress();
        }

        // 13. é«˜ç²¾åº¦å•å¥å¾ªç¯æ£€æµ‹
        function startLoopCheck() {
            stopLoopCheck();
            function checkLoop() {
                if (!isPlaying || !isSingleLoop || currentLyricIndex === -1 || isJumping) {
                    loopCheckTimer = requestAnimationFrame(checkLoop);
                    return;
                }
                
                const currentTime = audio.currentTime;
                
                if (currentTime >= sentenceEnd - 0.05) {
                    isJumping = true;
                    audio.currentTime = sentenceStart;
                    syncLyrics();
                    setTimeout(() => isJumping = false, 200);
                }
                
                loopCheckTimer = requestAnimationFrame(checkLoop);
            }
            loopCheckTimer = requestAnimationFrame(checkLoop);
        }

        function stopLoopCheck() {
            if (loopCheckTimer) {
                cancelAnimationFrame(loopCheckTimer);
                loopCheckTimer = null;
            }
        }

        // 14. æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            const percent = (audio.currentTime / audio.duration) * 100;
            els.progressFill.style.width = `${isNaN(percent) ? 0 : percent}%`;
            els.currentTime.textContent = formatTime(audio.currentTime);
            els.totalTime.textContent = formatTime(audio.duration);
            syncLyrics();
        }

        // 15. æ ¼å¼åŒ–æ—¶é—´
        function formatTime(sec) {
            if (isNaN(sec) || !isFinite(sec)) return '00:00';
            const m = Math.floor(sec/60).toString().padStart(2, '0');
            const s = Math.floor(sec%60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        // 16. ä¸‹è½½åŠŸèƒ½ - ä¿®æ”¹ç‰ˆ
        function downloadLyric() {
            if (!lyrics.length) {
                alert(`ç¬¬${currentVolume}å†Œç¬¬${currentVolumeLessons[currentLessonIndex].id}è¯¾æš‚æ— å­—å¹•å¯ä¸‹è½½`);
                return;
            }
            
            // æ„å»ºçº¯æ–‡æœ¬å­—å¹•ï¼ˆæ— æ—¶é—´æˆ³ï¼‰
            const currentLesson = currentVolumeLessons[currentLessonIndex];
            let lyricText = `æ–°æ¦‚å¿µè‹±è¯­${currentVolume} - ç¬¬${currentLesson.id}è¯¾ å­—å¹•\n`;
            lyricText += `ä¸‹è½½æ—¶é—´: ${new Date().toLocaleString()}\n\n`;
            
            lyrics.forEach(lyric => {
                lyricText += `${lyric.text}\n`;
            });

            // åˆ›å»ºBlobå¯¹è±¡å¹¶ä¸‹è½½
            const blob = new Blob([lyricText], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ–°æ¦‚å¿µè‹±è¯­${currentVolume}å†Œ-ç¬¬${currentLesson.id}è¯¾-å­—å¹•.txt`;
            document.body.appendChild(a);
            a.click();

            // æ¸…ç†èµ„æº
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        // ä¿®æ”¹ï¼šä¸‹è½½ç¿»è¯‘ - è·å–lyrics-containerå†…çš„æ–‡æœ¬
        function downloadTrans() {
            const lyricsContainer = document.getElementById('lyricsContainer');
            
            // è·å–å®¹å™¨å†…æ‰€æœ‰å¯è§æ–‡æœ¬ï¼ˆæ’é™¤ç©ºç™½è¡Œå’Œéšè—å…ƒç´ ï¼‰
            let transText = '';
            const allElements = lyricsContainer.querySelectorAll('*');
            
            allElements.forEach(el => {
                // æ’é™¤ç©ºç™½è¡Œå’Œéšè—å…ƒç´ 
                if (!el.classList.contains('blank-line') && el.style.visibility !== 'hidden') {
                    const text = el.textContent.trim();
                    if (text && text !== 'è¯·ç‚¹å‡»å·¦ä¾§æŒ‰é’®é€‰æ‹©è¯¾ç¨‹') {
                        transText += text + '\n';
                    }
                }
            });
            
            if (!transText) {
                alert('æš‚æ— ç¿»è¯‘æ–‡æœ¬å¯ä¸‹è½½ï¼Œè¯·å…ˆåŠ è½½å­—å¹•å¹¶ä½¿ç”¨æµè§ˆå™¨ç¿»è¯‘åŠŸèƒ½');
                return;
            }
            
            // æ„å»ºä¸‹è½½æ–‡æœ¬
            const currentLesson = currentVolumeLessons[currentLessonIndex];
            transText = `æ–°æ¦‚å¿µè‹±è¯­${currentVolume} - ç¬¬${currentLesson.id}è¯¾ ç¿»è¯‘\n` +
                        `ä¸‹è½½æ—¶é—´: ${new Date().toLocaleString()}\n\n` +
                        transText;
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([transText], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ–°æ¦‚å¿µè‹±è¯­${currentVolume}å†Œ-ç¬¬${currentLesson.id}è¯¾-ç¿»è¯‘.txt`;
            document.body.appendChild(a);
            a.click();
            
            // æ¸…ç†èµ„æº
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        // 17. æ›´æ–°å¾ªç¯çŠ¶æ€æ˜¾ç¤º
        function updateLoopStatus() {
            els.singleLoopBtn.classList.toggle('loop-active', isSingleLoop);
            els.fullLoopBtn.classList.toggle('loop-active', isFullLoop);
            
            els.loopStatus.className = isSingleLoop ? 'status-indicator' : 'status-indicator off';
            els.loopStatusText.textContent = isSingleLoop ? 'å•å¥å¾ªç¯ï¼šå¼€å¯' : 'å•å¥å¾ªç¯ï¼šå…³é—­';
            
            els.fullLoopStatus.className = isFullLoop ? 'status-indicator' : 'status-indicator off';
            els.fullLoopStatusText.textContent = isFullLoop ? 'æ•´é¦–å¾ªç¯ï¼šå¼€å¯' : 'æ•´é¦–å¾ªç¯ï¼šå…³é—­';
            
            els.singleLoopBtn.textContent = isSingleLoop ? 'å•å¥å¾ªç¯ï¼ˆå¼€å¯ï¼‰' : 'å•å¥å¾ªç¯';
            els.fullLoopBtn.textContent = isFullLoop ? 'æ•´é¦–å¾ªç¯ï¼ˆå¼€å¯ï¼‰' : 'æ•´é¦–å¾ªç¯';
            
            if (isPlaying && isSingleLoop) {
                startLoopCheck();
            }
            
            // ä¿å­˜è¿›åº¦
            saveProgress();
        }

        // 18. ä¸Šä¸€è¯¾/ä¸‹ä¸€è¯¾
        function prevLesson() {
            selectLesson(currentLessonIndex - 1);
        }
        function nextLesson() {
            selectLesson(currentLessonIndex + 1);
        }

        // æ–°å¢ï¼šè¯­é€Ÿè°ƒèŠ‚å‡½æ•°
        function changeSpeed(speed) {
            playbackSpeed = speed;
            audio.playbackRate = speed;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.speed === speed.toString());
            });
            // ä¿å­˜è¿›åº¦
            saveProgress();
        }

        // æ–°å¢ï¼šå­¦ä¹ è¿›åº¦ä¿å­˜å‡½æ•°
        function saveProgress() {
            const progress = {
                currentVolume: currentVolume,
                currentLessonIndex: currentLessonIndex,
                currentTime: audio.currentTime,
                isSingleLoop: isSingleLoop,
                isFullLoop: isFullLoop,
                playbackSpeed: playbackSpeed
            };
            localStorage.setItem('newConceptProgress', JSON.stringify(progress));
        }

        // æ–°å¢ï¼šå­¦ä¹ è¿›åº¦æ¢å¤å‡½æ•°
        function restoreProgress() {
            const progressStr = localStorage.getItem('newConceptProgress');
            if (!progressStr) return;
            
            try {
                const progress = JSON.parse(progressStr);
                
                // æ¢å¤åˆ†å†Œ
                if (progress.currentVolume && allLessons[progress.currentVolume]) {
                    currentVolume = progress.currentVolume;
                    currentVolumeLessons = allLessons[currentVolume];
                    
                    // æ›´æ–°Tabæ ·å¼
                    els.volumeTabs.forEach(tab => {
                        tab.classList.toggle('active', tab.dataset.volume === currentVolume.toString());
                    });
                    
                    // æ›´æ–°æŠ½å±‰æ ‡é¢˜
                    const totalLessons = {
                        1: 144,
                        2: 96,
                        3: 60,
                        4: 48
                    };
                    els.currentVolume.textContent = `å½“å‰ï¼šç¬¬${currentVolume}å†Œï¼ˆå…±${totalLessons[currentVolume]}è¯¾ï¼‰`;
                }
                
                // æ¢å¤è¯¾ç¨‹ç´¢å¼•
                if (progress.currentLessonIndex !== undefined && progress.currentLessonIndex < currentVolumeLessons.length) {
                    currentLessonIndex = progress.currentLessonIndex;
                }
                
                // æ¢å¤æ’­æ”¾è¿›åº¦
                if (progress.currentTime !== undefined) {
                    // å…ˆåˆå§‹åŒ–è¯¾ç¨‹åˆ—è¡¨
                    initLessonList();
                    // é€‰æ‹©è¯¾ç¨‹
                    selectLesson(currentLessonIndex);
                    // æ¢å¤æ’­æ”¾ä½ç½®
                    setTimeout(() => {
                        audio.currentTime = progress.currentTime;
                    }, 500);
                }
                
                // æ¢å¤å¾ªç¯çŠ¶æ€
                if (progress.isSingleLoop !== undefined) {
                    isSingleLoop = progress.isSingleLoop;
                }
                if (progress.isFullLoop !== undefined) {
                    isFullLoop = progress.isFullLoop;
                }
                updateLoopStatus();
                
                // æ¢å¤è¯­é€Ÿ
                if (progress.playbackSpeed !== undefined) {
                    playbackSpeed = progress.playbackSpeed;
                    audio.playbackRate = playbackSpeed;
                    document.querySelectorAll('.speed-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.speed === playbackSpeed.toString());
                    });
                }
                
            } catch (e) {
                console.error('æ¢å¤è¿›åº¦å¤±è´¥:', e);
            }
        }

        // 19. ç»‘å®šäº‹ä»¶ - ç¡®ä¿DOMå®Œå…¨åŠ è½½åç»‘å®š
        function bindEvents() {
            // æŠ½å±‰äº‹ä»¶ - ç¡®ä¿æŒ‰é’®å­˜åœ¨
            if (els.drawerBtn) {
                els.drawerBtn.onclick = toggleDrawer;
                console.log('æŠ½å±‰æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            }
            if (els.drawerMask) els.drawerMask.onclick = toggleDrawer;
            
            // åˆ†å†Œåˆ‡æ¢äº‹ä»¶
            els.volumeTabs.forEach(tab => {
                tab.onclick = () => switchVolume(parseInt(tab.dataset.volume));
            });

            // æ’­æ”¾æ§åˆ¶äº‹ä»¶
            els.playBtn.onclick = () => {
                if (isPlaying) {
                    pauseAudio();
                } else {
                    // å¦‚æœè¿˜æ²¡åŠ è½½éŸ³é¢‘ï¼ŒåŠ è½½å½“å‰è¯¾ç¨‹
                    if (!audio.src && currentVolumeLessons.length > 0) {
                        selectLesson(currentLessonIndex);
                    } else {
                        playAudio();
                    }
                }
            };
            els.prevBtn.onclick = prevLesson;
            els.nextBtn.onclick = nextLesson;
            
            // å¾ªç¯æ§åˆ¶
            els.singleLoopBtn.onclick = () => {
                if (!lyrics.length) {
                    alert('æš‚æ— å­—å¹•ï¼Œæ— æ³•å¼€å¯å•å¥å¾ªç¯');
                    return;
                }
                isSingleLoop = !isSingleLoop;
                updateLoopStatus();
                
                if (isSingleLoop && currentLyricIndex !== -1) {
                    updateSentenceRange();
                    if (isPlaying) {
                        startLoopCheck();
                    }
                } else {
                    stopLoopCheck();
                }
            };

            els.fullLoopBtn.onclick = () => {
                isFullLoop = !isFullLoop;
                updateLoopStatus();
            };

            // ä¸‹è½½åŠŸèƒ½
            els.downloadLyricBtn.onclick = downloadLyric;
            els.downloadTransBtn.onclick = downloadTrans;
            
            // è¿›åº¦æ¡
            els.progressBar.onclick = (e) => {
                const percent = e.offsetX / els.progressBar.offsetWidth;
                audio.currentTime = percent * audio.duration;
                syncLyrics();
                if (isSingleLoop) {
                    updateSentenceRange();
                }
                // ä¿å­˜è¿›åº¦
                saveProgress();
            };
            
            let isDragging = false;
            els.progressBar.addEventListener('mousedown', () => {
                isDragging = true;
                stopLoopCheck();
            });
            document.addEventListener('mouseup', () => {
                isDragging = false;
                if (audio.currentTime >= 0) {
                    syncLyrics();
                    if (isSingleLoop && isPlaying) {
                        updateSentenceRange();
                        startLoopCheck();
                    }
                    // ä¿å­˜è¿›åº¦
                    saveProgress();
                }
            });
            
            // éŸ³é¢‘äº‹ä»¶
            audio.ontimeupdate = () => {
                if (!isDragging) updateProgress();
            };
            
            audio.onloadedmetadata = () => {
                els.totalTime.textContent = formatTime(audio.duration);
                if (isSingleLoop && currentLyricIndex !== -1) {
                    updateSentenceRange();
                }
            };
            
            audio.onplay = () => {
                if (isSingleLoop) {
                    startLoopCheck();
                }
            };
            
            audio.onpause = () => {
                stopLoopCheck();
            };
            
            audio.onended = () => {
                if (isSingleLoop) {
                    audio.currentTime = sentenceStart;
                    audio.play();
                    return;
                }
                
                if (isFullLoop) {
                    audio.currentTime = 0;
                    audio.play();
                } else {
                    nextLesson();
                }
            };
            
            // è¯­é€Ÿè°ƒèŠ‚äº‹ä»¶
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.onclick = () => changeSpeed(parseFloat(btn.dataset.speed));
            });
            
            // è¯¾ç¨‹å®šä½äº‹ä»¶
            els.locateBtn.onclick = locateCurrentLesson;
            
            // è¯¾ç¨‹è·³è½¬äº‹ä»¶ï¼ˆæŒ‰é’®ç‚¹å‡» + å›è½¦ï¼‰
            els.jumpBtn.onclick = jumpToLesson;
            els.lessonJumpInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    jumpToLesson();
                }
            });
            
            // é¡µé¢å…³é—­/åˆ·æ–°æ—¶ä¿å­˜è¿›åº¦
            window.addEventListener('beforeunload', saveProgress);
        }

        // 20. åˆå§‹åŒ– - ç¡®ä¿DOMå®Œå…¨åŠ è½½
        async function init() {
            console.log('å¼€å§‹åˆå§‹åŒ–æ’­æ”¾å™¨...');
            
            // åˆå§‹åŒ–è¯¾ç¨‹åˆ—è¡¨ï¼ˆå³ä½¿æ²¡æœ‰è¿›åº¦ä¹Ÿæ˜¾ç¤ºï¼‰
            initLessonList();
            
            // é¢„åŠ è½½ZIPåŒ…åˆ°å†…å­˜
            await loadZipToMemory();
            
            // æ¢å¤å­¦ä¹ è¿›åº¦
            restoreProgress();
            
            // ç»‘å®šæ‰€æœ‰äº‹ä»¶
            bindEvents();
            
            console.log('æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ');
        }

        // ç¡®ä¿DOMå®Œå…¨åŠ è½½åå¯åŠ¨åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
