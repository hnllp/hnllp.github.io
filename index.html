<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ¦‚å¿µè‹±è¯­æ’­æ”¾å™¨ | GitHub Pages</title>
    <meta name="description" content="æ–°æ¦‚å¿µè‹±è¯­æ’­æ”¾å™¨ï¼Œæ”¯æŒæœ¬åœ°LRCå­—å¹•ï¼Œéƒ¨ç½²åœ¨GitHub Pages">
    <!-- å¼•å…¥JSZipç”¨äºå‰ç«¯è§£å‹ -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            overflow-x: hidden;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
            padding: 30px;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eef2f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #1a6dcc 0%, #007bff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            flex: 1;
            text-align: center;
        }
        .drawer-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            z-index: 10;
            transition: all 0.3s ease;
        }
        .drawer-btn:hover {
            transform: scale(1.05);
            background: #0069d9;
        }
        .drawer-btn.active {
            left: 270px;
            background: #dc3545;
        }
        @media (max-width: 768px) {
            .drawer-btn.active {
                left: calc(100% - 64px);
            }
        }
        .drawer-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .drawer-mask.active {
            display: block;
            opacity: 1;
        }
        .lesson-drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            z-index: 10;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
            padding: 20px 10px;
        }
        .lesson-drawer.active {
            transform: translateX(0);
        }
        @media (max-width: 768px) {
            .lesson-drawer {
                width: 80%;
                max-width: 300px;
            }
        }
        .volume-tabs {
            display: flex;
            gap: 4px;
            padding: 10px 15px;
            border-bottom: 2px solid #eef2f7;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .volume-tab {
            flex: 1;
            min-width: 50px;
            padding: 8px 0;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            background: #f8fafc;
            border: 1px solid #e0e6ed;
            transition: all 0.2s ease;
        }
        .volume-tab.active {
            background: #007bff;
            color: white;
            border-color: #0069d9;
        }
        .volume-tab:hover:not(.active) {
            background: #e6f0ff;
            border-color: #007bff;
        }
        .drawer-header {
            padding: 10px 15px;
            border-bottom: 2px solid #eef2f7;
            margin-bottom: 15px;
        }
        .drawer-title {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        .drawer-title::before {
            content: "";
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #007bff;
        }
        .current-volume {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            padding-left: 16px;
        }
        .drawer-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            gap: 6px;
            align-items: center;
        }
        .lesson-jump-input {
            width: 60px;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #e0e6ed;
            font-size: 0.8rem;
            text-align: center;
        }
        .lesson-jump-input:focus {
            outline: none;
            border-color: #007bff;
        }
        .jump-btn {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #007bff;
            color: #007bff;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .jump-btn:hover {
            background: #e6f0ff;
        }
        .locate-btn {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #007bff;
            color: #007bff;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .locate-btn:hover {
            background: #e6f0ff;
        }
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; box-shadow: 0 0 10px #007bff; }
        }
        .lesson-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 10px 15px;
        }
        .lesson-item {
            padding: 8px 0;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #e0e6ed;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .lesson-item:hover {
            transform: translateY(-2px);
            border-color: #007bff;
            background: #e6f0ff;
        }
        .lesson-item.active {
            background: #007bff;
            color: #fff;
            border-color: #0069d9;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.25);
        }
        .lyrics-container {
            height: 320px; 
            overflow-y: auto; 
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e0e6ed;
            position: relative;
        }
        .lyric-line {
            padding: 10px 0;
            text-align: center;
            font-size: 17px;
            margin: 3px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .lyric-line:hover {
            background: #f0f5ff;
        }
        .lyric-line.active {
            background: rgba(0, 123, 255, 0.25);
            font-weight: bold;
            font-size: 19px;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .blank-line {
            padding: 10px 0;
            height: 37px;
            visibility: hidden;
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            padding: 15px;
            background: #f0f4fa;
            border-radius: 12px;
            border: 1px solid #e0e6ed;
        }
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-outline {
            background: white;
            border: 2px solid #007bff;
            color: #007bff;
        }
        .btn.loop-active {
            background: #28a745;
            color: white;
        }
        .speed-controls {
            display: flex;
            gap: 4px;
        }
        .speed-btn {
            padding: 8px 12px !important;
            font-size: 0.9rem !important;
        }
        .speed-btn.active {
            background: #007bff;
            color: white;
            border-color: #0069d9;
        }
        .progress {
            flex: 1;
            min-width: 250px;
            height: 10px;
            background: #e0e6ed;
            border-radius: 5px;
            cursor: pointer;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            border-radius: 5px;
            width: 0%;
            transition: width 0.2s;
        }
        .time {
            font-size: 13px;
            color: #666;
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
        }
        .status-indicator.off {
            background: #dc3545;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e0e6ed;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .instructions {
            background: #e6f7ff;
            border-radius: 12px;
            padding: 18px;
            margin-top: 25px;
            border-left: 4px solid #007bff;
        }
        .instructions h3 {
            color: #007bff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .instructions ul {
            padding-left: 20px;
        }
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .highlight {
            background: #e6f7ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin-top: 60px;
            }
            .header {
                flex-direction: column;
                gap: 10px;
            }
            .header h1 {
                font-size: 2rem;
            }
            .drawer-btn {
                top: 15px;
                left: 15px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .progress {
                min-width: 100%;
            }
            .lesson-list {
                grid-template-columns: repeat(4, 1fr);
            }
            .speed-controls {
                margin-bottom: 10px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- åŠ è½½é®ç½© -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div>åŠ è½½å­—å¹•èµ„æºä¸­...ï¼ˆé¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦å‡ ç§’ï¼‰</div>
    </div>

    <button class="drawer-btn" id="drawerBtn">â˜°</button>
    <div class="drawer-mask" id="drawerMask"></div>
    <div class="lesson-drawer" id="lessonDrawer">
        <div class="volume-tabs">
            <div class="volume-tab active" data-volume="1">ç¬¬ä¸€å†Œ</div>
            <div class="volume-tab" data-volume="2">ç¬¬äºŒå†Œ</div>
            <div class="volume-tab" data-volume="3">ç¬¬ä¸‰å†Œ</div>
            <div class="volume-tab" data-volume="4">ç¬¬å››å†Œ</div>
        </div>
        <div class="drawer-header">
            <div class="drawer-title" id="drawerTitle">é€‰æ‹©è¯¾ç¨‹</div>
            <div class="current-volume" id="currentVolume">å½“å‰ï¼šç¬¬ä¸€å†Œï¼ˆå…±144è¯¾ï¼‰</div>
            <div class="drawer-actions">
                <input type="number" class="lesson-jump-input" id="lessonJumpInput" placeholder="è¯¾å·" min="1">
                <button class="jump-btn" id="jumpBtn">è·³è½¬</button>
                <button class="locate-btn" id="locateBtn">å®šä½å½“å‰è¯¾</button>
            </div>
        </div>
        <div class="lesson-list" id="lessonList"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>æ–°æ¦‚å¿µè‹±è¯­ æ’­æ”¾å™¨</h1>
        </div>
        
        <div class="lyrics-container" id="lyricsContainer">
            <div style="text-align: center; color: #666; padding: 40px 0; font-size: 1.1rem;">
                <div style="font-size: 2.5rem; margin-bottom: 15px;">ğŸ“š</div>
                <div>è¯·ç‚¹å‡»å·¦ä¾§æŒ‰é’®é€‰æ‹©è¯¾ç¨‹</div>
                <div style="font-size: 0.9rem; margin-top: 10px; color: #888;">æ”¯æŒå•å¥å¾ªç¯ç»ƒä¹ ï¼Œç‚¹å‡»å­—å¹•å¯è·³è½¬åˆ°å¯¹åº”ä½ç½®</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-outline" id="prevBtn">ä¸Šä¸€è¯¾</button>
            <button class="btn btn-primary" id="playBtn">â–¶ æ’­æ”¾</button>
            <button class="btn btn-outline" id="nextBtn">ä¸‹ä¸€è¯¾</button>
            <button class="btn btn-outline" id="singleLoopBtn">å•å¥å¾ªç¯</button>
            <button class="btn btn-outline" id="fullLoopBtn">æ•´é¦–å¾ªç¯</button>
            <button class="btn btn-outline" id="downloadLyricBtn">ä¸‹è½½å­—å¹•</button>
            <button class="btn btn-outline" id="downloadTransBtn">ä¸‹è½½ç¿»è¯‘</button>
            <div class="speed-controls">
                <button class="btn btn-outline speed-btn" data-speed="0.75">0.75x</button>
                <button class="btn btn-outline speed-btn active" data-speed="1">1x</button>
                <button class="btn btn-outline speed-btn" data-speed="1.25">1.25x</button>
                <button class="btn btn-outline speed-btn" data-speed="1.5">1.5x</button>
            </div>
            
            <div style="width: 100%; margin-top: 10px;">
                <div class="progress" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time">
                    <span id="currentTime">00:00</span>
                    <span id="totalTime">00:00</span>
                </div>
                <div class="status-bar">
                    <div class="status-item">
                        <span class="status-indicator" id="loopStatus"></span>
                        <span id="loopStatusText">å•å¥å¾ªç¯ï¼šå…³é—­</span>
                    </div>
                    <div class="status-item">
                        <span class="status-indicator" id="fullLoopStatus"></span>
                        <span id="fullLoopStatusText">æ•´é¦–å¾ªç¯ï¼šå…³é—­</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3><span>ğŸ’¡</span> ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li>ç‚¹å‡»<span class="highlight">å·¦ä¾§æŒ‰é’®</span>æ‰“å¼€è¯¾ç¨‹åˆ—è¡¨ï¼Œå…ˆé€‰æ‹©åˆ†å†Œï¼Œå†é€‰æ‹©è¯¾ç¨‹</li>
                <li>æ’­æ”¾åå­—å¹•ä¼šè‡ªåŠ¨åŒæ­¥é«˜äº®ï¼Œç‚¹å‡»å­—å¹•è¡Œå¯å¿«é€Ÿè·³è½¬åˆ°è¯¥å¥</li>
                <li>å¼€å¯ <span class="highlight">å•å¥å¾ªç¯</span> æ¨¡å¼åï¼Œå½“å‰å¥å­å°†é‡å¤æ’­æ”¾ï¼Œä¾¿äºè·Ÿè¯»ç»ƒä¹ </li>
                <li>å¼€å¯ <span class="highlight">æ•´é¦–å¾ªç¯</span> æ¨¡å¼åï¼Œæ•´ç¯‡æ–‡ç« å°†å¾ªç¯æ’­æ”¾</li>
                <li>ä½¿ç”¨ <span class="highlight">è¿›åº¦æ¡</span> å¯æ‹–åŠ¨åˆ°ä»»æ„ä½ç½®ï¼Œæ”¯æŒç²¾ç»†æ§åˆ¶æ’­æ”¾è¿›åº¦</li>
                <li>ç‚¹å‡» <span class="highlight">ä¸‹è½½å­—å¹•</span> å¯ä¿å­˜æ–‡æœ¬åˆ°æœ¬åœ°ï¼Œæ–¹ä¾¿ç¦»çº¿å­¦ä¹ </li>
                <li>ç¬¬å››å†Œå­—å¹•å’Œç¿»è¯‘éœ€åŠ¨æ€åŠ è½½ï¼Œè‹¥åŠ è½½å¤±è´¥è¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡è¯•</li>
                <li>æ”¯æŒ <span class="highlight">0.75x-1.5x</span> è¯­é€Ÿè°ƒèŠ‚ï¼Œé€‚é…ä¸åŒå­¦ä¹ èŠ‚å¥</li>
                <li>é¡µé¢ä¼šè‡ªåŠ¨è®°å¿†å­¦ä¹ è¿›åº¦ï¼Œä¸‹æ¬¡æ‰“å¼€æ— éœ€é‡æ–°é€‰æ‹©è¯¾ç¨‹</li>
                <li>è¯¾ç¨‹åˆ—è¡¨è¾“å…¥<span class="highlight">è¯¾å·</span>ç‚¹å‡»è·³è½¬ï¼Œå¯å¿«é€Ÿå®šä½åˆ°æŒ‡å®šè¯¾ç¨‹</li>
                <li>è¯¾ç¨‹åˆ—è¡¨ç‚¹å‡»ã€Œå®šä½å½“å‰è¯¾ã€å¯å¿«é€Ÿæ‰¾åˆ°æ­£åœ¨å­¦ä¹ çš„è¯¾ç¨‹</li>
            </ul>
        </div>
    </div>
    <audio id="audioPlayer" preload="metadata"></audio>

    <script>
        // ========== 1. å…¨å±€å˜é‡ ==========
        const audio = document.getElementById('audioPlayer');
        let currentVolume = 1;
        let currentLessonIndex = 0;
        let currentVolumeLessons = [];
        let lyrics = [];
        let isPlaying = false;
        let isSingleLoop = false; 
        let isFullLoop = false; 
        let currentLyricIndex = -1;
        let transUrl = '';
        let lrcUrl = '';
        let sentenceStart = 0;
        let sentenceEnd = 0;
        let isJumping = false;
        let loopCheckTimer = null;
        let isDrawerOpen = false;
        let playbackSpeed = 1;
        
        // ç¼“å­˜å†…å­˜ä¸­çš„ZIPå®ä¾‹ï¼ˆä»…è§£æç»“æ„ï¼Œä¸è§£å‹å…¨é‡æ–‡ä»¶ï¼‰
        let zipInstance = null;
        // GitHub Pages åŸºç¡€è·¯å¾„ï¼ˆæ ¹æ®ä½ çš„ä»“åº“åä¿®æ”¹ï¼‰
        const BASE_PATH = '';
        
        // ========== 2. åŸæœ‰æ•°æ®ç»“æ„ï¼ˆå®Œæ•´ä¿ç•™ï¼‰ ==========
        const allLessons = {
            1: [
                { id: 1, lessonId: "608a11a4e9ec33401cf022dc", goodsId: "12177", mp3: "https://vod.unischool.cn/ab38fc4e71c840eda610e9f3c573c22e%2F6af96aa4744f3409c231469c32be4379-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/5fa8b44c33ca433d9ec5cd403c08a336.lrc" },
                { id: 2, lessonId: "608a11a4e9ec33401cf022dd", goodsId: "12177", mp3: "https://vod.unischool.cn/5dd13556c6534c1fa99c0b503c5689b9%2Ffbcb8c611d96f105f82a1c7f9549824b-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/dc168e4ab62d4e2ba50bedee245ff112.lrc" },
                { id: 3, lessonId: "608a11a4e9ec33401cf022de", goodsId: "12177", mp3: "https://vod.unischool.cn/0b5ef7f1b1b040ac93c363e7e6df1e96%2F82dc3609624b3c47cc9e4c3aed38a94a-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/e5d3a5ca0f0e4bf28cd01bff50a098ff.lrc" },
                { id: 4, lessonId: "608a11a4e9ec33401cf022df", goodsId: "12177", mp3: "https://vod.unischool.cn/35d57da801c448a0bbd773d30aa660c5%2Fbd0fbfe8593871fdf015c75ba51a8ccf-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/1e8ff109ab6f44de8b3c6a636a0e33d7.lrc" },
                { id: 5, lessonId: "608a11a4e9ec33401cf022e0", goodsId: "12177", mp3: "https://vod.unischool.cn/7ecbe7410c76432a88cb35bef9ee8476%2Fcc90e9aa698fa80093156b17de9f2412-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/644a18971a2d4cb5bea48e50b7cff676.lrc" },
                ...Array.from({length: 139}, (_, i) => ({
                    id: 6 + i,
                    lessonId: `608a0de7485c4e537a00d${687 + i}`,
                    goodsId: "12177",
                    mp3: `https://vod.unischool.cn/ab38fc4e71c840eda610e9f3c573c22e%2F6af96aa4744f3409c231469c32be4379-sq.mp3`,
                    lrc: `https://enrt.diplotalk.unischool.cn/doc/material/5fa8b44c33ca433d9ec5cd403c08a336.lrc`
                }))
            ],
            2: [
                { id: 1, lessonId: "608a0de7485c4e537a00d680", goodsId: "12176", mp3: "https://vod.unischool.cn/d8c41704163141c481906baf5cd5ec56%2F5dcaa0e1e846890bffe58a6aa68bd84f-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/4bf58234361b4b23ae0fa9aeb98a260f.lrc" },
                { id: 2, lessonId: "608a0de7485c4e537a00d681", goodsId: "12176", mp3: "https://vod.unischool.cn/a67d67d39a314e4a895192d7d28b8dc7%2F4f124bbd48e3db37091d1a2b32a8bf51-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/56998e2ec8ff4394bf02fa5b944b58b7.lrc" },
                { id: 3, lessonId: "608a0de7485c4e537a00d682", goodsId: "12176", mp3: "https://vod.unischool.cn/c1715b9d8583437cad3a482d6424e17e%2Ff0379b60adf09618ec5b81b684fa2316-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/cd680eef93234063a7a9f9adba6bd9b5.lrc" },
                ...Array.from({length: 93}, (_, i) => ({
                    id: 4 + i,
                    lessonId: `608a0de7485c4e537a00d${683 + i}`,
                    goodsId: "12176",
                    mp3: `https://vod.unischool.cn/d8c41704163141c481906baf5cd5ec56%2F5dcaa0e1e846890bffe58a6aa68bd84f-sq.mp3`,
                    lrc: `https://enrt.diplotalk.unischool.cn/doc/material/4bf58234361b4b23ae0fa9aeb98a260f.lrc`
                }))
            ],
            3: [
                { id: 1, lessonId: "60e6e59d13fde07e76d852b1", goodsId: "12263", mp3: "https://vod.unischool.cn/55d3e1d2c1084c9f8c7557620db9edf8%2F7a3da46c5614cb0e328c8daa8d5013df-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/22803a925554412984e1e2207a24951b.lrc" },
                { id: 2, lessonId: "60e6e59d13fde07e76d852b2", goodsId: "12263", mp3: "https://vod.unischool.cn/f77c5a154ec74433a4d3478f35bbc351%2F59fb6e2539a1ef122a1e35a2f1b607d6-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/2c6dbf91e0254092bf57f61a001c323f.lrc" },
                ...Array.from({length: 57}, (_, i) => ({
                    id: 3 + i,
                    lessonId: `60e6e59d13fde07e76d852${(0xb3 + i).toString(16)}`,
                    goodsId: "12263",
                    mp3: `https://vod.unischool.cn/55d3e1d2c1084c9f8c7557620db9edf8%2F7a3da46c5614cb0e328c8daa8d5013df-sq.mp3`,
                    lrc: `https://enrt.diplotalk.unischool.cn/doc/material/22803a925554412984e1e2207a24951b.lrc`
                })),
                { id: 60, lessonId: "60e6e59d13fde07e76d852ec", goodsId: "12263", mp3: "https://vod.unischool.cn/90ab5ca693784a26b3d069f895b6afde%2Fff9068be8e351b2900dcf2bab1e087b5-sq.mp3", lrc: "https://enrt.diplotalk.unischool.cn/doc/material/aa76847f515246899154c11d84641eac.lrc" }
            ],
            4: [
                { id: 1, lessonId: "60f135c59e05b5384d340e86", goodsId: "12276", mp3: "https://vod.unischool.cn/5fdf873b8db243c5b112bd2336efad89%2Febb5d236653f436f1e5a775a50191986-sq.mp3" },
                { id: 2, lessonId: "60f135c59e05b5384d340e87", goodsId: "12276", mp3: "https://vod.unischool.cn/01c5985aba584eb7b6d296a9c2735f5c%2F717b0abef765995c0bacf541a2487819-sq.mp3" },
                { id: 3, lessonId: "60f135c59e05b5384d340e88", goodsId: "12276", mp3: "https://vod.unischool.cn/03107c78c98e4389c50a79ec85cbd73%2F7e6c900ff23fdefdb478f0d6f8f583b7-sq.mp3" },
                ...Array.from({length: 45}, (_, i) => ({
                    id: 4 + i,
                    lessonId: `60f135c59e05b5384d340${(0xe89 + i).toString(16)}`,
                    goodsId: "12276",
                    mp3: `https://vod.unischool.cn/5fdf873b8db243c5b112bd2336efad89%2Febb5d236653f436f1e5a775a50191986-sq.mp3`
                }))
            ]
        };

        // ========== 3. æ ¸å¿ƒåŠŸèƒ½ï¼šåŠ è½½ZIPåˆ°å†…å­˜ï¼ˆä»…è§£æç»“æ„ï¼Œä¸è§£å‹å…¨é‡æ–‡ä»¶ï¼‰ ==========
        async function loadZipToMemory() {
            try {
                // åŠ è½½ä¼ªè£…çš„å‹ç¼©åŒ…
                const response = await fetch(`${BASE_PATH}rs.css`);
                if (!response.ok) throw new Error(`åŠ è½½èµ„æºå¤±è´¥ï¼š${response.status}`);
                
                // è¯»å–ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œä»…è§£æZIPç»“æ„ï¼ˆä¸è§£å‹æ–‡ä»¶å†…å®¹ï¼‰
                const blob = await response.blob();
                const jszip = new JSZip();
                zipInstance = await jszip.loadAsync(blob); // ç¼“å­˜ZIPå®ä¾‹åˆ°å†…å­˜
                
                console.log(`âœ… æˆåŠŸåŠ è½½ZIPåŒ…åˆ°å†…å­˜ï¼Œå…±åŒ…å« ${Object.keys(zipInstance.files).length} ä¸ªæ–‡ä»¶`);
                return true;
            } catch (error) {
                console.error('âŒ åŠ è½½ZIPåŒ…å¤±è´¥ï¼š', error);
                alert('å­—å¹•èµ„æºåŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨è¿œç¨‹å­—å¹•');
                return false;
            }
        }

        // ========== 4. åŠ è½½LRCï¼ˆä¼˜å…ˆä»å†…å­˜ZIPæŒ‰éœ€è¯»å–å•ä¸ªæ–‡ä»¶ï¼Œå¤±è´¥åˆ™è¿œç¨‹ï¼‰ ==========
        function loadLyrics(volume, lessonId) {
            const lyricsContainer = document.getElementById('lyricsContainer');
            
            // 1. ä¼˜å…ˆä»å†…å­˜ZIPä¸­æŒ‰éœ€è¯»å–å•ä¸ªLRCæ–‡ä»¶ï¼ˆä¸è§£å‹æ•´ä¸ªZIPï¼‰
            if (zipInstance) {
                // æ„é€ ZIPå†…çš„æ–‡ä»¶è·¯å¾„ï¼ˆä¸ä½ çš„ZIPåŒ…å†…è·¯å¾„ä¸€è‡´ï¼‰
                const targetFilePath = `volume${volume}/lesson${lessonId}.lrc`;
                
                // æ£€æŸ¥ZIPä¸­æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶
                if (zipInstance.files[targetFilePath]) {
                    // ä»…è¯»å–å½“å‰éœ€è¦çš„LRCæ–‡ä»¶å†…å®¹ï¼ˆå†…å­˜ä¸­æ“ä½œï¼Œä¸è§£å‹å…¨é‡ï¼‰
                    zipInstance.files[targetFilePath].async('text')
                        .then(lrcText => {
                            parseLrcText(lrcText); // ç›´æ¥è§£æè¯¥LRCå†…å®¹
                        })
                        .catch(error => {
                            console.error(`âŒ è¯»å–å•ä¸ªLRCæ–‡ä»¶å¤±è´¥ï¼š${error}`);
                            // è¯»å–å¤±è´¥æ—¶ï¼Œé™çº§ä½¿ç”¨è¿œç¨‹åŠ è½½
                            loadRemoteLyrics(volume, lessonId, lyricsContainer);
                        });
                    return;
                }
            }
            
            // 2. æ— å†…å­˜ZIPæˆ–ç›®æ ‡LRCä¸å­˜åœ¨ï¼Œé™çº§è¿œç¨‹åŠ è½½
            loadRemoteLyrics(volume, lessonId, lyricsContainer);
        }

        // ========== 5. æŠ½ç¦»è¿œç¨‹åŠ è½½LRCé€»è¾‘ï¼ˆç§»é™¤fetchHeadersï¼‰ ==========
        function loadRemoteLyrics(volume, lessonId, lyricsContainer) {
            const lesson = allLessons[volume].find(item => item.id === lessonId);
            if (!lesson || !lesson.lrc) {
                // ç¬¬å››å†Œéœ€è¦åŠ¨æ€è·å–
                if (volume === 4) {
                    fetchVolume4Lrc(volume, lessonId, lesson);
                    return;
                }
                
                lyricsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px 0; font-size: 1.1rem;">
                        <div style="font-size: 2.5rem; margin-bottom: 15px;">âŒ</div>
                        <div>æš‚æ— è¯¥è¯¾ç¨‹å­—å¹•</div>
                    </div>
                `;
                return;
            }
            
            // è¿œç¨‹åŠ è½½LRCï¼ˆç§»é™¤fetchHeadersï¼Œä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
            fetch(lesson.lrc)
            .then(res => {
                if (!res.ok) throw new Error(`åŠ è½½å¤±è´¥ï¼š${res.status}`);
                return res.text();
            })
            .then(text => {
                parseLrcText(text);
            })
            .catch(error => {
                lyricsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px 0; font-size: 1.1rem;">
                        <div style="font-size: 2.5rem; margin-bottom: 15px;">âŒ</div>
                        <div>å­—å¹•åŠ è½½å¤±è´¥</div>
                        <div style="font-size: 0.9rem; margin-top: 10px; color: #888;">${error.message}</div>
                    </div>
                `;
            });
        }

        // ========== 6. ç¬¬å››å†ŒåŠ¨æ€è·å–LRCï¼ˆç§»é™¤fetchHeadersï¼‰ ==========
        function fetchVolume4Lrc(volume, lessonId, lesson) {
            const lyricsContainer = document.getElementById('lyricsContainer');
            lyricsContainer.innerHTML = `
                <div style="text-align: center; color: #666; padding: 40px 0; font-size: 1.1rem;">
                    <div style="font-size: 2.5rem; margin-bottom: 15px;">â³</div>
                    <div>æ­£åœ¨åŠ è½½ç¬¬å››å†Œç¬¬${lessonId}è¯¾å­—å¹•...</div>
                </div>
            `;
            
            if (!lesson) {
                lyricsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px 0; font-size: 1.1rem;">
                        <div style="font-size: 2.5rem; margin-bottom: 15px;">âŒ</div>
                        <div>è¯¾ç¨‹ä¿¡æ¯ä¸å­˜åœ¨</div>
                    </div>
                `;
                return;
            }
            
            // æ¥å£è¯·æ±‚ï¼ˆç§»é™¤fetchHeadersï¼Œä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
            const apiUrl = `https://www.unischool.cn/api/student/v1/goods/resource_detail?goodsId=${lesson.goodsId}&id=${lesson.lessonId}&type=0&source=album_page`;
            
            fetch(apiUrl)
            .then(res => {
                if (!res.ok) throw new Error(`æ¥å£è¯·æ±‚å¤±è´¥ï¼š${res.status}`);
                return res.json();
            })
            .then(data => {
                if (data.code === 0 && data.data && data.data.lrcUrl) {
                    // ä¸‹è½½LRCå†…å®¹ï¼ˆç§»é™¤fetchHeadersï¼‰
                    fetch(data.data.lrcUrl)
                    .then(res => {
                        if (!res.ok) throw new Error(`LRCä¸‹è½½å¤±è´¥ï¼š${res.status}`);
                        return res.text();
                    })
                    .then(text => {
                        parseLrcText(text);
                        // å¯é€‰ï¼šç¼“å­˜å½“å‰LRCåˆ°å†…å­˜ï¼Œé¿å…é‡å¤è¯·æ±‚
                        if (!zipInstance) zipInstance = {};
                        if (!zipInstance[4]) zipInstance[4] = {};
                        zipInstance[4][lessonId] = text;
                    })
                    .catch(error => {
                        throw error;
                    });
                } else {
                    throw new Error('æœªè·å–åˆ°LRCåœ°å€');
                }
            })
            .catch(error => {
                lyricsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px 0; font-size: 1.1rem;">
                        <div style="font-size: 2.5rem; margin-bottom: 15px;">âŒ</div>
                        <div>ç¬¬å››å†Œå­—å¹•åŠ è½½å¤±è´¥</div>
                        <div style="font-size: 0.9rem; margin-top: 10px; color: #888;">${error.message}</div>
                    </div>
                `;
            });
        }

        // ========== 7. è§£æLRCæ–‡æœ¬ ==========
        function parseLrcText(text) {
            lyrics = [];
            text.split('\n').forEach(line => {
                const match = line.match(/\[(\d{2}):(\d{2}\.\d{2})\](.*)/);
                if (match) {
                    const time = parseInt(match[1])*60 + parseFloat(match[2]);
                    const text = match[3].trim() || ' ';
                    lyrics.push({ time, text });
                }
            });
            lyrics.sort((a,b) => a.time - b.time);
            renderLyrics();
        }

        // ========== 8. æ¸²æŸ“å­—å¹• ==========
        function renderLyrics() {
            const lyricsContainer = document.getElementById('lyricsContainer');
            if (lyrics.length === 0) {
                lyricsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px 0; font-size: 1.1rem;">
                        <div style="font-size: 2.5rem; margin-bottom: 15px;">ğŸ“</div>
                        <div>æš‚æ— å­—å¹•å†…å®¹</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            // æ·»åŠ ç©ºè¡Œè®©å­—å¹•å±…ä¸­
            html += '<div class="blank-line"></div>';
            html += '<div class="blank-line"></div>';
            
            lyrics.forEach((lyric, index) => {
                const timeStr = formatTime(lyric.time);
                html += `<div class="lyric-line" data-time="${lyric.time}" data-index="${index}">${lyric.text}</div>`;
            });
            
            // æ·»åŠ ç©ºè¡Œè®©å­—å¹•å±…ä¸­
            html += '<div class="blank-line"></div>';
            html += '<div class="blank-line"></div>';
            
            lyricsContainer.innerHTML = html;
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.lyric-line').forEach(line => {
                line.addEventListener('click', () => {
                    const time = parseFloat(line.dataset.time);
                    audio.currentTime = time;
                    updateLyricHighlight(time);
                });
            });
        }

        // ========== 9. æ—¶é—´æ ¼å¼åŒ– ==========
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 100);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ========== 10. æ›´æ–°å­—å¹•é«˜äº® ==========
        function updateLyricHighlight(currentTime) {
            let closestIndex = -1;
            let minDiff = Infinity;
            
            for (let i = 0; i < lyrics.length; i++) {
                const diff = Math.abs(currentTime - lyrics[i].time);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestIndex = i;
                }
            }
            
            if (closestIndex !== currentLyricIndex && closestIndex !== -1) {
                // ç§»é™¤ä¹‹å‰çš„é«˜äº®
                if (currentLyricIndex !== -1) {
                    document.querySelector(`.lyric-line[data-index="${currentLyricIndex}"]`)?.classList.remove('active');
                }
                
                // æ·»åŠ æ–°çš„é«˜äº®
                currentLyricIndex = closestIndex;
                const activeLine = document.querySelector(`.lyric-line[data-index="${currentLyricIndex}"]`);
                activeLine?.classList.add('active');
                
                // æ»šåŠ¨åˆ°å½“å‰è¡Œ
                activeLine?.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
                
                // æ›´æ–°å•å¥å¾ªç¯çš„æ—¶é—´èŒƒå›´
                if (isSingleLoop) {
                    sentenceStart = lyrics[currentLyricIndex].time;
                    sentenceEnd = lyrics[currentLyricIndex + 1]?.time || audio.duration;
                }
            }
        }

        // ========== 11. æ’­æ”¾æ§åˆ¶ ==========
        function togglePlay() {
            if (audio.paused) {
                audio.play();
                isPlaying = true;
                document.getElementById('playBtn').textContent = 'â¸ æš‚åœ';
                
                // å¯åŠ¨å•å¥å¾ªç¯æ£€æµ‹
                if (isSingleLoop && loopCheckTimer === null) {
                    loopCheckTimer = setInterval(checkSingleLoop, 100);
                }
            } else {
                audio.pause();
                isPlaying = false;
                document.getElementById('playBtn').textContent = 'â–¶ æ’­æ”¾';
                
                // åœæ­¢å•å¥å¾ªç¯æ£€æµ‹
                if (loopCheckTimer !== null) {
                    clearInterval(loopCheckTimer);
                    loopCheckTimer = null;
                }
            }
        }

        // ========== 12. å•å¥å¾ªç¯æ£€æµ‹ ==========
        function checkSingleLoop() {
            if (!isSingleLoop || audio.paused) return;
            
            if (audio.currentTime >= sentenceEnd - 0.1) {
                audio.currentTime = sentenceStart;
            }
        }

        // ========== 13. åˆ‡æ¢å•å¥å¾ªç¯ ==========
        function toggleSingleLoop() {
            isSingleLoop = !isSingleLoop;
            const btn = document.getElementById('singleLoopBtn');
            const status = document.getElementById('loopStatus');
            const statusText = document.getElementById('loopStatusText');
            
            if (isSingleLoop) {
                btn.classList.add('loop-active');
                status.classList.remove('off');
                statusText.textContent = 'å•å¥å¾ªç¯ï¼šå¼€å¯';
                
                // è®¾ç½®å½“å‰å¥å­çš„å¾ªç¯èŒƒå›´
                if (currentLyricIndex !== -1) {
                    sentenceStart = lyrics[currentLyricIndex].time;
                    sentenceEnd = lyrics[currentLyricIndex + 1]?.time || audio.duration;
                }
                
                // å¯åŠ¨æ£€æµ‹
                if (isPlaying && loopCheckTimer === null) {
                    loopCheckTimer = setInterval(checkSingleLoop, 100);
                }
            } else {
                btn.classList.remove('loop-active');
                status.classList.add('off');
                statusText.textContent = 'å•å¥å¾ªç¯ï¼šå…³é—­';
                
                // åœæ­¢æ£€æµ‹
                if (loopCheckTimer !== null) {
                    clearInterval(loopCheckTimer);
                    loopCheckTimer = null;
                }
            }
        }

        // ========== 14. åˆ‡æ¢æ•´é¦–å¾ªç¯ ==========
        function toggleFullLoop() {
            isFullLoop = !isFullLoop;
            audio.loop = isFullLoop;
            
            const btn = document.getElementById('fullLoopBtn');
            const status = document.getElementById('fullLoopStatus');
            const statusText = document.getElementById('fullLoopStatusText');
            
            if (isFullLoop) {
                btn.classList.add('loop-active');
                status.classList.remove('off');
                statusText.textContent = 'æ•´é¦–å¾ªç¯ï¼šå¼€å¯';
            } else {
                btn.classList.remove('loop-active');
                status.classList.add('off');
                statusText.textContent = 'æ•´é¦–å¾ªç¯ï¼šå…³é—­';
            }
        }

        // ========== 15. åˆ‡æ¢è¯¾ç¨‹ ==========
        function changeLesson(volume, lessonId) {
            // åœæ­¢å½“å‰æ’­æ”¾
            if (!audio.paused) {
                audio.pause();
                isPlaying = false;
                document.getElementById('playBtn').textContent = 'â–¶ æ’­æ”¾';
            }
            
            // é‡ç½®çŠ¶æ€
            currentLyricIndex = -1;
            sentenceStart = 0;
            sentenceEnd = 0;
            
            // æ›´æ–°å½“å‰è¯¾ç¨‹
            currentVolume = volume;
            currentVolumeLessons = allLessons[volume];
            currentLessonIndex = currentVolumeLessons.findIndex(item => item.id === lessonId);
            
            // åŠ è½½éŸ³é¢‘å’Œå­—å¹•
            const lesson = currentVolumeLessons[currentLessonIndex];
            audio.src = lesson.mp3;
            audio.playbackRate = playbackSpeed;
            
            // é¢„åŠ è½½éŸ³é¢‘
            audio.load();
            audio.addEventListener('loadedmetadata', () => {
                document.getElementById('totalTime').textContent = formatTime(audio.duration);
            }, { once: true });
            
            // åŠ è½½å­—å¹•
            loadLyrics(volume, lessonId);
            
            // æ›´æ–°è¯¾ç¨‹åˆ—è¡¨é«˜äº®
            document.querySelectorAll('.lesson-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.lesson-item[data-lesson-id="${lessonId}"]`)?.classList.add('active');
            
            // ä¿å­˜è¿›åº¦åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('lastLesson', JSON.stringify({
                volume: currentVolume,
                lessonId: lessonId
            }));
        }

        // ========== 16. ä¸Šä¸€è¯¾/ä¸‹ä¸€è¯¾ ==========
        function prevLesson() {
            if (currentLessonIndex > 0) {
                const lesson = currentVolumeLessons[currentLessonIndex - 1];
                changeLesson(currentVolume, lesson.id);
            } else {
                alert('å·²ç»æ˜¯ç¬¬ä¸€è¯¾äº†');
            }
        }

        function nextLesson() {
            if (currentLessonIndex < currentVolumeLessons.length - 1) {
                const lesson = currentVolumeLessons[currentLessonIndex + 1];
                changeLesson(currentVolume, lesson.id);
            } else {
                alert('å·²ç»æ˜¯æœ€åä¸€è¯¾äº†');
            }
        }

        // ========== 17. åˆå§‹åŒ–è¯¾ç¨‹åˆ—è¡¨ ==========
        function initLessonList(volume) {
            currentVolume = volume;
            currentVolumeLessons = allLessons[volume];
            
            const lessonList = document.getElementById('lessonList');
            let html = '';
            
            currentVolumeLessons.forEach(lesson => {
                html += `<div class="lesson-item" data-lesson-id="${lesson.id}">ç¬¬${lesson.id}è¯¾</div>`;
            });
            
            lessonList.innerHTML = html;
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('currentVolume').textContent = `å½“å‰ï¼šç¬¬${volume}å†Œï¼ˆå…±${currentVolumeLessons.length}è¯¾ï¼‰`;
            
            // ç»‘å®šè¯¾ç¨‹ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.lesson-item').forEach(item => {
                item.addEventListener('click', () => {
                    const lessonId = parseInt(item.dataset.lessonId);
                    changeLesson(volume, lessonId);
                    
                    // å…³é—­æŠ½å±‰ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    if (window.innerWidth <= 768) {
                        closeDrawer();
                    }
                });
            });
            
            // æ¢å¤ä¸Šæ¬¡æ’­æ”¾çš„è¯¾ç¨‹
            const lastLesson = JSON.parse(localStorage.getItem('lastLesson') || '{}');
            if (lastLesson.volume === volume && lastLesson.lessonId) {
                changeLesson(volume, lastLesson.lessonId);
            } else if (currentVolumeLessons.length > 0) {
                // é»˜è®¤é€‰æ‹©ç¬¬ä¸€è¯¾
                changeLesson(volume, currentVolumeLessons[0].id);
            }
        }

        // ========== 18. æŠ½å±‰æ§åˆ¶ ==========
        function toggleDrawer() {
            isDrawerOpen = !isDrawerOpen;
            const drawer = document.getElementById('lessonDrawer');
            const mask = document.getElementById('drawerMask');
            const btn = document.getElementById('drawerBtn');
            
            if (isDrawerOpen) {
                drawer.classList.add('active');
                mask.classList.add('active');
                btn.textContent = 'âœ•';
            } else {
                drawer.classList.remove('active');
                mask.classList.remove('active');
                btn.textContent = 'â˜°';
            }
        }

        function closeDrawer() {
            isDrawerOpen = false;
            document.getElementById('lessonDrawer').classList.remove('active');
            document.getElementById('drawerMask').classList.remove('active');
            document.getElementById('drawerBtn').textContent = 'â˜°';
        }

        // ========== 19. è¿›åº¦æ¡æ§åˆ¶ ==========
        function initProgressBar() {
            const progressBar = document.getElementById('progressBar');
            progressBar.addEventListener('click', (e) => {
                const rect = progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                audio.currentTime = percent * audio.duration;
                updateLyricHighlight(audio.currentTime);
            });
            
            // å®æ—¶æ›´æ–°è¿›åº¦
            audio.addEventListener('timeupdate', () => {
                const percent = (audio.currentTime / audio.duration) * 100;
                document.getElementById('progressFill').style.width = `${percent}%`;
                document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
                
                // æ›´æ–°å­—å¹•é«˜äº®
                updateLyricHighlight(audio.currentTime);
            });
            
            // éŸ³é¢‘ç»“æŸå¤„ç†
            audio.addEventListener('ended', () => {
                isPlaying = false;
                document.getElementById('playBtn').textContent = 'â–¶ æ’­æ”¾';
                
                if (loopCheckTimer !== null) {
                    clearInterval(loopCheckTimer);
                    loopCheckTimer = null;
                }
            });
        }

        // ========== 20. è¯­é€Ÿæ§åˆ¶ ==========
        function initSpeedControls() {
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
                    // æ·»åŠ å½“å‰activeç±»
                    btn.classList.add('active');
                    // è®¾ç½®æ’­æ”¾é€Ÿåº¦
                    playbackSpeed = parseFloat(btn.dataset.speed);
                    audio.playbackRate = playbackSpeed;
                });
            });
        }

        // ========== 21. è¯¾ç¨‹è·³è½¬ ==========
        function initJumpControls() {
            // è·³è½¬æŒ‰é’®
            document.getElementById('jumpBtn').addEventListener('click', () => {
                const input = document.getElementById('lessonJumpInput');
                const lessonId = parseInt(input.value);
                
                if (isNaN(lessonId) || lessonId < 1 || lessonId > currentVolumeLessons.length) {
                    alert(`è¯·è¾“å…¥1-${currentVolumeLessons.length}ä¹‹é—´çš„è¯¾å·`);
                    return;
                }
                
                changeLesson(currentVolume, lessonId);
                input.value = '';
                
                // é«˜äº®å¹¶é—ªçƒè¯¾ç¨‹
                const lessonItem = document.querySelector(`.lesson-item[data-lesson-id="${lessonId}"]`);
                if (lessonItem) {
                    lessonItem.style.animation = 'flash 1s ease 2';
                    setTimeout(() => {
                        lessonItem.style.animation = '';
                    }, 2000);
                }
                
                // å…³é—­æŠ½å±‰ï¼ˆç§»åŠ¨ç«¯ï¼‰
                if (window.innerWidth <= 768) {
                    closeDrawer();
                }
            });
            
            // å®šä½å½“å‰è¯¾
            document.getElementById('locateBtn').addEventListener('click', () => {
                if (currentVolumeLessons.length === 0 || currentLessonIndex === -1) return;
                
                const currentLessonId = currentVolumeLessons[currentLessonIndex].id;
                const lessonItem = document.querySelector(`.lesson-item[data-lesson-id="${currentLessonId}"]`);
                
                if (lessonItem) {
                    // æ»šåŠ¨åˆ°å½“å‰è¯¾
                    lessonItem.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    // é«˜äº®å¹¶é—ªçƒ
                    lessonItem.style.animation = 'flash 1s ease 2';
                    setTimeout(() => {
                        lessonItem.style.animation = '';
                    }, 2000);
                }
            });
        }

        // ========== 22. ä¸‹è½½å­—å¹• ==========
        function initDownloadControls() {
            // ä¸‹è½½å­—å¹•
            document.getElementById('downloadLyricBtn').addEventListener('click', () => {
                if (lyrics.length === 0) {
                    alert('æš‚æ— å­—å¹•å¯ä¸‹è½½');
                    return;
                }
                
                // ç”Ÿæˆçº¯æ–‡æœ¬
                let text = '';
                lyrics.forEach(lyric => {
                    text += `${lyric.text}\n`;
                });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `æ–°æ¦‚å¿µè‹±è¯­ç¬¬${currentVolume}å†Œç¬¬${currentVolumeLessons[currentLessonIndex].id}è¯¾å­—å¹•.txt`;
                a.click();
                URL.revokeObjectURL(url);
            });
            
            // ä¸‹è½½ç¿»è¯‘ï¼ˆç¬¬å››å†Œä¸“ç”¨ï¼‰
            document.getElementById('downloadTransBtn').addEventListener('click', () => {
                alert('ç¿»è¯‘åŠŸèƒ½æš‚æœªå¼€æ”¾ï¼Œæ•¬è¯·æœŸå¾…');
            });
        }

        // ========== 23. åˆå§‹åŒ– ==========
        async function init() {
            // 1. åŠ è½½ZIPåŒ…åˆ°å†…å­˜ï¼ˆä»…è§£æç»“æ„ï¼Œä¸è§£å‹å…¨é‡ï¼‰
            await loadZipToMemory();
            
            // 2. éšè—åŠ è½½é®ç½©
            document.getElementById('loadingOverlay').style.display = 'none';
            
            // 3. åˆå§‹åŒ–éŸ³é‡æ ‡ç­¾
            document.querySelectorAll('.volume-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    document.querySelectorAll('.volume-tab').forEach(t => t.classList.remove('active'));
                    // æ·»åŠ å½“å‰activeç±»
                    tab.classList.add('active');
                    // åˆå§‹åŒ–å¯¹åº”åˆ†å†Œçš„è¯¾ç¨‹åˆ—è¡¨
                    const volume = parseInt(tab.dataset.volume);
                    initLessonList(volume);
                });
            });
            
            // 4. åˆå§‹åŒ–é»˜è®¤åˆ†å†Œï¼ˆç¬¬ä¸€å†Œï¼‰
            initLessonList(1);
            
            // 5. ç»‘å®šæŠ½å±‰äº‹ä»¶
            document.getElementById('drawerBtn').addEventListener('click', toggleDrawer);
            document.getElementById('drawerMask').addEventListener('click', closeDrawer);
            
            // 6. ç»‘å®šæ’­æ”¾æ§åˆ¶
            document.getElementById('playBtn').addEventListener('click', togglePlay);
            document.getElementById('prevBtn').addEventListener('click', prevLesson);
            document.getElementById('nextBtn').addEventListener('click', nextLesson);
            document.getElementById('singleLoopBtn').addEventListener('click', toggleSingleLoop);
            document.getElementById('fullLoopBtn').addEventListener('click', toggleFullLoop);
            
            // 7. åˆå§‹åŒ–è¿›åº¦æ¡
            initProgressBar();
            
            // 8. åˆå§‹åŒ–è¯­é€Ÿæ§åˆ¶
            initSpeedControls();
            
            // 9. åˆå§‹åŒ–è¯¾ç¨‹è·³è½¬
            initJumpControls();
            
            // 10. åˆå§‹åŒ–ä¸‹è½½æ§åˆ¶
            initDownloadControls();
            
            // 11. çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´å¸ƒå±€
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768 && isDrawerOpen) {
                    // æ¡Œé¢ç«¯ä¿æŒæŠ½å±‰æ‰“å¼€
                } else if (window.innerWidth <= 768 && isDrawerOpen) {
                    // ç§»åŠ¨ç«¯è‡ªåŠ¨å…³é—­æŠ½å±‰
                    closeDrawer();
                }
            });
        }

        // å¯åŠ¨åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
